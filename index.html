<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ARCANE EXTRACTION v2</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:#060608;display:flex;align-items:center;justify-content:center;width:100vw;height:100vh;font-family:'Share Tech Mono',monospace;overflow:hidden;color:#c8b89a;touch-action:none}
#app{position:absolute;width:900px;height:600px;background:#0d0d14;transform-origin:top left}
canvas{display:block}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;inset:0;pointer-events:none}
#top-bar{position:absolute;top:0;left:0;right:0;height:38px;background:linear-gradient(180deg,rgba(0,0,0,.7),transparent);display:flex;align-items:center;padding:0 12px;gap:16px}
#zone-label{font-family:'Cinzel',serif;font-size:10px;color:#4a3a2a;letter-spacing:3px;flex:1;text-align:center}
.stat-block{display:flex;flex-direction:column;gap:2px;min-width:120px}
.bar-label{font-size:7px;color:#5a5060;letter-spacing:2px}
.bar-bg{height:6px;background:#1a1a22;border:1px solid #2a2a35;position:relative;border-radius:1px}
.bar-fill{height:100%;border-radius:1px;transition:width .15s}
#hp-fill{background:linear-gradient(90deg,#e53e3e,#fc8181)}
#xp-fill{background:linear-gradient(90deg,#6366f1,#a5b4fc)}
#gold-display{font-size:11px;color:#fbbf24;text-shadow:0 0 8px #fbbf2460;white-space:nowrap}

#log{position:absolute;top:44px;left:10px;width:200px;max-height:72px;overflow:hidden;display:flex;flex-direction:column;gap:1px;pointer-events:none}
.log-line{font-size:8px;color:#4a4a5a;line-height:1.4;animation:fadeIn .3s}
.log-line.imp{color:#fbbf24}.log-line.dmg{color:#fc8181}.log-line.loot{color:#4ade80}.log-line.info{color:#67e8f9}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}

/* Minimap */
#minimap{position:absolute;top:10px;right:10px;width:90px;height:90px;border:1px solid #2a2a35;background:#080810;pointer-events:none}

/* Elevation indicator */
#elev-badge{position:absolute;top:44px;right:10px;font-size:8px;color:#67e8f9;letter-spacing:2px;text-align:right;pointer-events:none;margin-top:96px}

/* Pickup bar */
#pickup-bar-wrap{position:absolute;bottom:130px;left:50%;transform:translateX(-50%);width:160px;display:none;flex-direction:column;align-items:center;gap:4px;pointer-events:none}
#pickup-label{font-size:8px;color:#fbbf24;letter-spacing:2px}
#pickup-bg{width:160px;height:8px;background:#1a1a22;border:1px solid #fbbf2460}
#pickup-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b);width:0%;transition:width .05s linear}

/* Equipped weapon */
#weapon-hud{position:absolute;bottom:10px;left:10px;padding:6px 10px;border:1px solid #2a2a35;background:#0d0d14cc;pointer-events:none;min-width:110px}
#weapon-name{font-size:9px;color:#fbbf24;font-family:'Cinzel',serif;margin-bottom:2px}
#weapon-stats{font-size:8px;color:#5a5a6a;line-height:1.5}

/* â”€â”€ GRID INVENTORY PANEL â”€â”€ */
#inv-panel{position:absolute;bottom:10px;right:10px;background:#0a0a12;border:1px solid #2a2a35;padding:8px;width:220px;pointer-events:all}
#inv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
#inv-title{font-size:8px;color:#5a5060;letter-spacing:2px}
#inv-weight{font-size:8px;color:#6a5a4a}
#inv-grid{display:grid;grid-template-columns:repeat(6,30px);grid-template-rows:repeat(4,30px);gap:2px}
.inv-cell{width:30px;height:30px;border:1px solid #1e1e2a;background:#0d0d14;position:relative}
.inv-cell.occupied{border-color:#2a2a3a}
.inv-item-block{position:absolute;top:0;left:0;border:1px solid;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;z-index:2}
.inv-item-block:hover{filter:brightness(1.3)}
.inv-item-block.selected{box-shadow:0 0 0 2px #fbbf24}
#inv-actions{display:flex;gap:4px;margin-top:6px}
.inv-btn{flex:1;padding:4px;font-family:'Share Tech Mono',monospace;font-size:8px;background:none;border:1px solid #2a2a35;color:#c8b89a;cursor:pointer;letter-spacing:1px}
.inv-btn:hover{border-color:#fbbf24;color:#fbbf24}
.inv-btn:disabled{opacity:.3;cursor:default}

/* â”€â”€ HOMEBASE SCREEN â”€â”€ */
#homebase{position:absolute;inset:0;background:#07070f;display:none;flex-direction:column}
#hb-header{background:#0d0d18;border-bottom:1px solid #1a1a28;padding:12px 20px;display:flex;align-items:center;gap:20px}
#hb-title{font-family:'Cinzel',serif;font-size:16px;color:#c8b89a;letter-spacing:4px}
#hb-gold{font-size:12px;color:#fbbf24;text-shadow:0 0 10px #fbbf2450}
#hb-btn-raid{margin-left:auto;padding:8px 20px;background:none;border:1px solid #4a3a2a;color:#fbbf24;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:2px}
#hb-btn-raid:hover{background:#fbbf2415;border-color:#fbbf24}
#hb-body{display:flex;flex:1;overflow:hidden}
#hb-storage{flex:1;padding:16px;border-right:1px solid #1a1a28;overflow-y:auto}
#hb-market{width:280px;padding:16px;overflow-y:auto}
.hb-section-title{font-size:9px;color:#4a4060;letter-spacing:3px;margin-bottom:10px;border-bottom:1px solid #1a1a22;padding-bottom:4px}
#storage-grid{display:grid;grid-template-columns:repeat(5,54px);gap:4px}
.storage-slot{width:54px;height:54px;border:1px solid #1a1a28;background:#0a0a10;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:18px;cursor:pointer;position:relative}
.storage-slot:hover{border-color:#2a2a3a}
.storage-slot .slot-name{font-size:6px;color:#4a4a5a;text-align:center;position:absolute;bottom:3px;width:100%;padding:0 2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.storage-slot.occupied{border-color:#2a2a3a;background:#0d0d18}
.storage-slot.selected-storage{border-color:#fbbf24!important}
#market-list{display:flex;flex-direction:column;gap:4px}
.market-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #1a1a22;background:#0a0a10;cursor:pointer}
.market-item:hover{border-color:#2a2a35}
.market-item .mi-icon{font-size:16px;width:24px;text-align:center}
.market-item .mi-info{flex:1}
.market-item .mi-name{font-size:8px;color:#c8b89a}
.market-item .mi-price{font-size:7px;color:#5a5a6a;margin-top:2px}
.market-item .mi-price .price-val{color:#fbbf24}
.market-item .mi-price .price-trend{font-size:6px}
.market-item .mi-price .up{color:#4ade80}.market-item .mi-price .down{color:#f87171}
.market-item .mi-action{font-size:7px;padding:3px 8px;background:none;border:1px solid;cursor:pointer;font-family:'Share Tech Mono',monospace}
.mi-sell{border-color:#4ade8066;color:#4ade80}.mi-sell:hover{background:#4ade8015}
.mi-buy{border-color:#6366f166;color:#a5b4fc}.mi-buy:hover{background:#6366f115}
.mi-sell:disabled,.mi-buy:disabled{opacity:.3;cursor:default}
#hb-storage-actions{display:flex;gap:6px;margin-top:8px}
.hb-action-btn{padding:4px 10px;background:none;border:1px solid #2a2a35;color:#c8b89a;font-family:'Share Tech Mono',monospace;font-size:8px;cursor:pointer}
.hb-action-btn:hover{border-color:#fbbf24;color:#fbbf24}
.hb-action-btn:disabled{opacity:.3;cursor:default}
#loadout-section{margin-top:16px}
#loadout-grid{display:grid;grid-template-columns:repeat(5,54px);gap:4px;margin-top:6px}
.loadout-slot{width:54px;height:54px;border:1px dashed #1a1a28;background:#0a0a10;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:18px;cursor:pointer;position:relative}
.loadout-slot .slot-name{font-size:6px;color:#4a4a5a;position:absolute;bottom:3px;width:100%;text-align:center}
.loadout-slot.occupied{border-style:solid;border-color:#2a2a3a}
.loadout-slot.selected-loadout{border-color:#6366f1!important}

/* â”€â”€ OVERLAY SCREENS â”€â”€ */
.overlay-screen{position:absolute;inset:0;background:#00000099;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.overlay-screen h1{font-family:'Cinzel',serif;letter-spacing:6px}
.overlay-screen p{font-size:10px;color:#6a5a4a}
.overlay-screen button{padding:8px 24px;background:none;border:1px solid #4a3a2a;color:#c8b89a;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:2px}
.overlay-screen button:hover{border-color:#fbbf24;color:#fbbf24}
#death-screen h1{color:#e53e3e;text-shadow:0 0 30px #e53e3e80}
#extract-screen h1{color:#4ade80;text-shadow:0 0 30px #4ade8080;font-size:22px}
#extract-screen .summary{font-size:9px;color:#a8c8a8;text-align:center;line-height:2.2}
#extract-screen button{border-color:#2a4a2a;color:#4ade80}

/* â”€â”€ TOUCH CONTROLS â”€â”€ */
#touch-zone{position:absolute;inset:0;pointer-events:none}
#joystick-base{position:absolute;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.1);bottom:100px;left:30px;pointer-events:all;display:none}
#joystick-knob{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.3);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
#touch-btns{position:absolute;bottom:100px;right:10px;display:none;flex-direction:column;gap:8px;pointer-events:all}
.tbtn{width:60px;height:60px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:7px;border:1.5px solid;cursor:pointer;letter-spacing:1px;gap:2px}
#tbtn-pickup{background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.4);color:#fbbf24}
#tbtn-cycle{background:rgba(99,102,241,.12);border-color:rgba(99,102,241,.4);color:#a5b4fc}
#tbtn-home{background:rgba(74,222,128,.12);border-color:rgba(74,222,128,.4);color:#4ade80}
.tbtn-icon{font-size:18px;line-height:1}
</style>
</head>
<body>
<div id="app">
  <canvas id="canvas" width="900" height="600"></canvas>

  <!-- IN-RAID HUD -->
  <div id="hud">
    <div id="top-bar">
      <div class="stat-block">
        <div class="bar-label">VITALITY</div>
        <div class="bar-bg" style="width:120px"><div class="bar-fill" id="hp-fill" style="width:100%"></div></div>
      </div>
      <div class="stat-block">
        <div class="bar-label">XP</div>
        <div class="bar-bg" style="width:80px"><div class="bar-fill" id="xp-fill" style="width:0%"></div></div>
      </div>
      <div id="zone-label">FORSAKEN SANCTUM</div>
      <div id="gold-display">â—ˆ 0</div>
    </div>
    <div id="log"></div>
    <div id="minimap"><canvas id="mm-canvas" width="90" height="90"></canvas></div>
    <div id="elev-badge"></div>
    <div id="pickup-bar-wrap">
      <div id="pickup-label">LOOTING...</div>
      <div id="pickup-bg"><div id="pickup-fill"></div></div>
    </div>
    <div id="weapon-hud">
      <div id="weapon-name">BARE HANDS</div>
      <div id="weapon-stats">DMG 5â€“8 Â· RNG 40</div>
    </div>
    <div id="inv-panel">
      <div id="inv-header">
        <div id="inv-title">BACKPACK</div>
        <div id="inv-weight">0 / 6 slots</div>
      </div>
      <div id="inv-grid"></div>
      <div id="inv-actions">
        <button class="inv-btn" id="btn-equip" disabled onclick="equipSelected()">EQUIP</button>
        <button class="inv-btn" id="btn-drop" disabled onclick="dropSelected()">DROP</button>
      </div>
    </div>
  </div>

  <!-- PICKUP PROGRESS (canvas overlay) -->

  <!-- DEATH / EXTRACT OVERLAYS -->
  <div class="overlay-screen" id="death-screen">
    <h1>SLAIN</h1>
    <p id="death-msg"></p>
    <button onclick="goHomebase()">RETURN TO BASE</button>
  </div>
  <div class="overlay-screen" id="extract-screen">
    <h1>EXTRACTED</h1>
    <div class="summary" id="extract-summary"></div>
    <button onclick="goHomebase()">RETURN TO BASE</button>
  </div>

  <!-- HOMEBASE -->
  <div id="homebase">
    <div id="hb-header">
      <div id="hb-title">HOME BASE</div>
      <div id="hb-gold">â—ˆ <span id="hb-gold-val">0</span></div>
      <button id="hb-btn-raid" onclick="startRaid()">â–¶ RAID</button>
    </div>
    <div id="hb-body">
      <!-- Storage -->
      <div id="hb-storage">
        <div class="hb-section-title">STASH</div>
        <div id="storage-grid"></div>
        <div id="hb-storage-actions">
          <button class="hb-action-btn" id="btn-to-loadout" onclick="moveToLoadout()" disabled>â†’ LOADOUT</button>
          <button class="hb-action-btn" id="btn-from-loadout" onclick="moveFromLoadout()" disabled>â† STASH</button>
        </div>
        <div id="loadout-section">
          <div class="hb-section-title">LOADOUT (å¸¦å…¥ä¸‹å±€)</div>
          <div id="loadout-grid"></div>
        </div>
      </div>
      <!-- Market -->
      <div id="hb-market">
        <div class="hb-section-title">ARCANE MARKET</div>
        <div id="market-list"></div>
      </div>
    </div>
  </div>

  <!-- TOUCH -->
  <div id="touch-zone">
    <div id="joystick-base"><div id="joystick-knob"></div></div>
    <div id="touch-btns">
      <div class="tbtn" id="tbtn-pickup" ontouchstart="startPickupTouch(event)"><div class="tbtn-icon">â—†</div>æ‹¾å–</div>
      <div class="tbtn" id="tbtn-cycle" ontouchstart="cycleWeapon()"><div class="tbtn-icon">âš¡</div>åˆ‡æ¢</div>
      <div class="tbtn" id="tbtn-home" ontouchstart="goHomebase()"><div class="tbtn-icon">âŒ‚</div>æ’¤ç¦»</div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W=900,H=600,MAP_W=2000,MAP_H=1600,TILE=40;
const COLS=Math.ceil(MAP_W/TILE),ROWS=Math.ceil(MAP_H/TILE);
const PICKUP_TIME=1.8; // seconds to loot
const PICKUP_RANGE=46;
const JOYSTICK_MAX=40;

// Elevation levels: 0=low, 1=mid, 2=high
// High can hit all, Mid can hit Mid+Low, Low can only hit Low
const ELEV_NAMES=['LOW GROUND','MID GROUND','HIGH GROUND'];
const ELEV_COLORS=['#4a3a2a','#4a4a2a','#2a4a5a'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAND DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WANDS=[
  {id:'ember',   name:'EMBER WAND',  icon:'ğŸ”¥',dmg:[12,18],range:160,spd:1.5,color:'#f97316',proj:'#fb923c',desc:'ç«ç„°Â·ä¸­è·',   size:[1,3],basePrice:120,aoe:0},
  {id:'frost',   name:'FROST STAFF', icon:'â„ï¸', dmg:[8,14], range:240,spd:0.9,color:'#67e8f9',proj:'#a5f3fc',desc:'å†°éœœÂ·è¿œè·Â·å‡é€Ÿ',size:[1,3],basePrice:150,slow:true,aoe:0},
  {id:'thunder', name:'THUNDER ROD', icon:'âš¡', dmg:[22,34],range:130,spd:0.55,color:'#fbbf24',proj:'#fde68a',desc:'é›·å‡»Â·é«˜ä¼¤',  size:[1,3],basePrice:200,aoe:0},
  {id:'void',    name:'VOID SCEPTER',icon:'ğŸŒ€',dmg:[15,22],range:190,spd:1.1,color:'#a855f7',proj:'#c084fc',desc:'è™šç©ºÂ·AOEç©¿é€',size:[1,3],basePrice:180,aoe:32,pierce:true},
  {id:'nature',  name:'NATURE WAND', icon:'ğŸŒ¿',dmg:[10,16],range:200,spd:1.3,color:'#4ade80',proj:'#86efac',desc:'è‡ªç„¶Â·å¸è¡€',  size:[1,3],basePrice:160,vamp:true,aoe:0},
  {id:'ancient', name:'ANCIENT TOME',icon:'ğŸ“œ',dmg:[28,44],range:260,spd:0.45,color:'#fcd34d',proj:'#fef08a',desc:'è¿œå¤Â·è¶…é«˜ä¼¤',size:[1,3],basePrice:300,aoe:0},
  {id:'poison',  name:'POISON ORB',  icon:'ğŸ’€',dmg:[6,10], range:170,spd:1.6,color:'#84cc16',proj:'#bef264',desc:'æ¯’Â·æŒç»­ä¼¤å®³', size:[1,2],basePrice:100,dot:true,aoe:0},
  {id:'blood',   name:'BLOOD LANCE', icon:'ğŸ©¸',dmg:[18,28],range:150,spd:0.8,color:'#dc2626',proj:'#f87171',desc:'è¡€çŸ›Â·é«˜ç©¿é€', size:[1,3],basePrice:220,pierce:true,aoe:0},
];

// Market prices fluctuate each visit
let marketPrices={};
function refreshMarket(){
  WANDS.forEach(w=>{
    const base=w.basePrice;
    const factor=0.8+Math.random()*0.4;
    marketPrices[w.id]=Math.round(base*factor);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gold=200;
let stash=[];       // wands in homebase stash
let loadout=[];     // wands player brings to raid (max 3)
let selectedStorage=null; // index in stash selected
let selectedLoadout=null; // index in loadout selected

// In-raid
let gameState='homebase'; // homebase | playing | dead | extracted
let frames=0,lastTime=0;
let tileMap=[],elevMap=[];
let enemies=[],chests=[],droppedWands=[],projectiles=[],particles=[];
let player={};
let cam={x:0,y:0};
let pickupTarget=null,pickupProgress=0,pickupHolding=false;
let selectedInvIdx=null;
// Touch
const isTouchDevice=()=>navigator.maxTouchPoints>0;
let joystickDelta={x:0,y:0},joystickActive=false,joystickOrigin={x:0,y:0};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genMap(){
  tileMap=[];elevMap=[];
  for(let r=0;r<ROWS;r++){
    tileMap[r]=[];elevMap[r]=[];
    for(let c=0;c<COLS;c++){
      if(r===0||r===ROWS-1||c===0||c===COLS-1){tileMap[r][c]=1;elevMap[r][c]=0;continue;}
      const n=Math.sin(r*7.3+c*13.1)*Math.cos(r*3.7-c*5.9);
      tileMap[r][c]=n>0.58?1:0;
      // Elevation: clusters based on secondary noise
      const e2=Math.sin(r*2.1+c*3.7)*Math.cos(r*1.9-c*2.3);
      elevMap[r][c]=e2>0.5?2:e2>0.1?1:0;
      if(tileMap[r][c]===1)elevMap[r][c]=0;
    }
  }
  // Clear spawn
  for(let r=2;r<8;r++)for(let c=2;c<12;c++){tileMap[r][c]=0;elevMap[r][c]=0;}
  // Clear extract
  for(let r=ROWS-7;r<ROWS-1;r++)for(let c=COLS-7;c<COLS-1;c++){tileMap[r][c]=0;elevMap[r][c]=0;}
}

function isSolid(wx,wy){
  const c=Math.floor(wx/TILE),r=Math.floor(wy/TILE);
  if(r<0||r>=ROWS||c<0||c>=COLS)return true;
  return tileMap[r][c]===1;
}
function getElev(wx,wy){
  const c=Math.floor(wx/TILE),r=Math.floor(wy/TILE);
  if(r<0||r>=ROWS||c<0||c>=COLS)return 0;
  return elevMap[r][c]||0;
}
function canAttack(attackerElev,targetElev){
  // High hits all, mid hits mid+low, low hits only low
  return attackerElev>=targetElev;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ENEMY_TYPES=[
  {name:'SHADE',  hp:65,  spd:1.3,dmg:9,  color:'#6366f1',r:12,xp:20,elev:0},
  {name:'WRAITH', hp:130, spd:0.9,dmg:15, color:'#a855f7',r:16,xp:40,elev:1},
  {name:'GOLEM',  hp:320, spd:0.45,dmg:28,color:'#78716c',r:22,xp:100,elev:0},
  {name:'SPECTER',hp:50,  spd:2.3,dmg:6,  color:'#22d3ee',r:9, xp:15,elev:0},
  {name:'CULTIST',hp:95,  spd:1.0,dmg:19, color:'#dc2626',r:14,xp:35,elev:1},
  {name:'ARCHER', hp:70,  spd:0.8,dmg:14, color:'#f59e0b',r:11,xp:30,elev:2,ranged:true,range:200},
];

function spawnEnemies(){
  enemies=[];
  for(let i=0;i<28;i++){
    let wx,wy,tries=0;
    do{wx=200+Math.random()*(MAP_W-400);wy=200+Math.random()*(MAP_H-400);tries++;}
    while((isSolid(wx,wy)||dist(wx,wy,160,160)<220)&&tries<60);
    const t=ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
    const spawnElev=t.elev||getElev(wx,wy);
    enemies.push({wx,wy,hp:t.hp,maxHp:t.hp,spd:t.spd,dmg:t.dmg,color:t.color,r:t.r,xp:t.xp,name:t.name,
      elev:spawnElev,attackCd:0,attackRate:1.1,aggroRange:200,wanderAngle:Math.random()*Math.PI*2,
      dropWand:Math.random()<0.14,slowTimer:0,dotTimer:0,ranged:t.ranged||false,range:t.range||60,
      phase:Math.random()*Math.PI*2});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnChests(){
  chests=[];
  for(let i=0;i<16;i++){
    let wx,wy,tries=0;
    do{wx=80+Math.random()*(MAP_W-160);wy=80+Math.random()*(MAP_H-160);tries++;}
    while(isSolid(wx,wy)&&tries<50);
    const wand=WANDS[Math.floor(Math.random()*WANDS.length)];
    chests.push({wx,wy,wand,opened:false,gp:Math.random()*Math.PI*2});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INV_COLS=6,INV_ROWS=4;

function initPlayer(){
  player={
    wx:160,wy:160,
    hp:100,maxHp:100,
    spd:2.9,r:12,
    inventory:[],        // {wand, gridX, gridY} placed in grid
    equippedIdx:null,    // index in inventory
    xp:0,xpNext:100,level:1,
    attackCd:0,
    elev:0,
  };
  // Place loadout wands into inventory
  loadout.forEach((w,i)=>{
    if(w) placeWandInGrid(w);
  });
  updateInvGrid();
}

function placeWandInGrid(wand){
  // Try to find free space in 6x4 grid; wand is 1Ã—3 (1 wide, 3 tall) or 1Ã—2
  const [sw,sh]=wand.size;
  for(let gy=0;gy<=INV_ROWS-sh;gy++){
    for(let gx=0;gx<=INV_COLS-sw;gx++){
      if(canPlace(gx,gy,sw,sh)){
        player.inventory.push({wand:{...wand},gx,gy});
        if(player.equippedIdx===null)player.equippedIdx=player.inventory.length-1;
        return true;
      }
    }
  }
  return false; // no space
}

function canPlace(gx,gy,sw,sh,excludeIdx=null){
  for(const item of player.inventory){
    if(player.inventory.indexOf(item)===excludeIdx)continue;
    const [isw,ish]=item.wand.size;
    if(gx<item.gx+isw&&gx+sw>item.gx&&gy<item.gy+ish&&gy+sh>item.gy)return false;
  }
  return true;
}

function getEquipped(){
  if(player.equippedIdx===null||player.equippedIdx>=player.inventory.length)return null;
  return player.inventory[player.equippedIdx]?.wand||null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTORY GRID UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CELL=30,GAP=2;
function updateInvGrid(){
  const grid=document.getElementById('inv-grid');
  grid.innerHTML='';
  // Background cells
  for(let r=0;r<INV_ROWS;r++)for(let c=0;c<INV_COLS;c++){
    const cell=document.createElement('div');
    cell.className='inv-cell';
    grid.appendChild(cell);
  }
  // Item blocks
  player.inventory.forEach((item,idx)=>{
    const [sw,sh]=item.wand.size;
    const block=document.createElement('div');
    block.className='inv-item-block'+(selectedInvIdx===idx?' selected':'');
    block.style.cssText=`
      left:${item.gx*(CELL+GAP)}px;
      top:${item.gy*(CELL+GAP)}px;
      width:${sw*CELL+(sw-1)*GAP}px;
      height:${sh*CELL+(sh-1)*GAP}px;
      background:${item.wand.color}22;
      border-color:${item.wand.color}88;
      font-size:16px;
      color:${item.wand.color};
    `;
    block.textContent=item.wand.icon;
    block.title=item.wand.name+'\n'+item.wand.desc;
    block.onclick=()=>{
      selectedInvIdx=(selectedInvIdx===idx)?null:idx;
      updateInvGrid();
      document.getElementById('btn-equip').disabled=selectedInvIdx===null;
      document.getElementById('btn-drop').disabled=selectedInvIdx===null;
    };
    grid.appendChild(block);
  });
  const slots=player.inventory.length;
  document.getElementById('inv-weight').textContent=`${slots} / 6 slots`;

  // Weapon HUD
  const w=getEquipped();
  document.getElementById('weapon-name').textContent=w?w.name:'BARE HANDS';
  document.getElementById('weapon-stats').textContent=w?`DMG ${w.dmg[0]}â€“${w.dmg[1]} Â· RNG ${w.range}`:'DMG 5â€“8 Â· RNG 40';
  // HP/XP
  document.getElementById('hp-fill').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('xp-fill').style.width=(player.xp/player.xpNext*100)+'%';
}

function equipSelected(){
  if(selectedInvIdx===null)return;
  player.equippedIdx=selectedInvIdx;
  addLog(`è£…å¤‡: ${player.inventory[selectedInvIdx].wand.name}`,'info');
  updateInvGrid();
}

function dropSelected(){
  if(selectedInvIdx===null)return;
  const item=player.inventory.splice(selectedInvIdx,1)[0];
  droppedWands.push({wx:player.wx+Math.cos(Math.random()*Math.PI*2)*20,wy:player.wy+Math.sin(Math.random()*Math.PI*2)*20,wand:item.wand});
  if(player.equippedIdx>=player.inventory.length)player.equippedIdx=player.inventory.length>0?0:null;
  selectedInvIdx=null;
  document.getElementById('btn-equip').disabled=true;
  document.getElementById('btn-drop').disabled=true;
  addLog('ä¸¢å¼ƒäº†ä¸€ä»¶ç‰©å“','info');
  updateInvGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKUP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePickup(dt){
  if(!pickupTarget){
    pickupProgress=0;
    document.getElementById('pickup-bar-wrap').style.display='none';
    return;
  }
  const d=dist(player.wx,player.wy,pickupTarget.wx,pickupTarget.wy);
  if(d>PICKUP_RANGE){
    // Left range, reset
    pickupProgress=0;
    pickupTarget=null;
    document.getElementById('pickup-bar-wrap').style.display='none';
    addLog('æ‹¾å–ä¸­æ–­','info');
    return;
  }
  pickupProgress+=dt/PICKUP_TIME;
  document.getElementById('pickup-bar-wrap').style.display='flex';
  document.getElementById('pickup-fill').style.width=(pickupProgress*100)+'%';
  document.getElementById('pickup-label').textContent='LOOTING: '+pickupTarget.wand.name;

  if(pickupProgress>=1){
    finishPickup();
  }
}

function finishPickup(){
  if(!pickupTarget)return;
  const wand=pickupTarget.wand;
  const placed=placeWandInGrid(wand);
  if(!placed){
    addLog('èƒŒåŒ…å·²æ»¡!','dmg');
    pickupTarget=null;pickupProgress=0;
    document.getElementById('pickup-bar-wrap').style.display='none';
    return;
  }
  // Remove from world
  const ci=chests.findIndex(c=>c===pickupTarget);
  if(ci>=0){chests[ci].opened=true;}
  else{const di=droppedWands.findIndex(d=>d===pickupTarget);if(di>=0)droppedWands.splice(di,1);}
  addLog(`æ‹¾å–: ${wand.name}`,'loot');
  spawnParticles(pickupTarget.wx,pickupTarget.wy,wand.color,12,3);
  pickupTarget=null;pickupProgress=0;
  document.getElementById('pickup-bar-wrap').style.display='none';
  updateInvGrid();
}

function tryStartPickup(){
  // Find nearest lootable
  let best=null,bestD=PICKUP_RANGE;
  for(const ch of chests){
    if(ch.opened)continue;
    const d=dist(player.wx,player.wy,ch.wx,ch.wy);
    if(d<bestD){bestD=d;best=ch;}
  }
  for(const dw of droppedWands){
    const d=dist(player.wx,player.wy,dw.wx,dw.wy);
    if(d<bestD){bestD=d;best=dw;}
  }
  if(best){
    if(pickupTarget===best)return; // already looting this
    pickupTarget=best;
    pickupProgress=0;
    addLog(`å¼€å§‹æ‹¾å– ${best.wand.name}...`,'info');
  }
}

function startPickupTouch(e){e.preventDefault();tryStartPickup();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(wx,wy,color,count=8,speed=2){
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*speed+.5;
    particles.push({wx,wy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,maxLife:1,color,r:Math.random()*4+1});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playerShoot(dt){
  const w=getEquipped();
  const rate=w?w.spd:1.2;
  player.attackCd-=dt;
  if(player.attackCd>0)return;
  const range=w?w.range:40;
  const pElev=getElev(player.wx,player.wy);

  let closest=null,closestD=Infinity;
  for(const e of enemies){
    if(!canAttack(pElev,e.elev))continue; // can't hit higher ground
    const d=dist(player.wx,player.wy,e.wx,e.wy);
    if(d<range&&d<closestD){closestD=d;closest=e;}
  }
  if(!closest)return;

  player.attackCd=1/rate;
  const [nx,ny]=normalize(closest.wx-player.wx,closest.wy-player.wy);
  projectiles.push({
    wx:player.wx,wy:player.wy,
    vx:nx*5,vy:ny*5,
    dmg:(w?w.dmg[0]:5)+Math.random()*((w?w.dmg[1]:8)-(w?w.dmg[0]:5)),
    color:w?w.proj:'#e2e8f0',
    life:1.6,r:w&&w.aoe>0?8:5,
    aoe:w?w.aoe:0,pierce:w?!!w.pierce:false,
    slow:w?!!w.slow:false,vamp:w?!!w.vamp:false,
    dot:w?!!w.dot:false,
    fromElev:pElev,
    hit:new Set(),
  });
}

function updateEnemies(dt){
  for(const e of enemies){
    e.phase+=dt;
    const d=dist(player.wx,player.wy,e.wx,e.wy);
    const pElev=getElev(player.wx,player.wy);

    if(d<e.aggroRange){
      const [nx,ny]=normalize(player.wx-e.wx,player.wy-e.wy);
      const spd=(e.slowTimer>0)?e.spd*.4:e.spd;
      const nx2=e.wx+nx*spd,ny2=e.wy+ny*spd;
      if(!isSolid(nx2,e.wy))e.wx=nx2;
      if(!isSolid(e.wx,ny2))e.wy=ny2;
      // Update elevation to terrain
      e.elev=getElev(e.wx,e.wy);
    }else{
      e.wanderAngle+=(Math.random()-.5)*.2;
      const nx2=e.wx+Math.cos(e.wanderAngle)*.6,ny2=e.wy+Math.sin(e.wanderAngle)*.6;
      if(!isSolid(nx2,e.wy))e.wx=nx2;else e.wanderAngle+=Math.PI/2;
      if(!isSolid(e.wx,ny2))e.wy=ny2;
      e.elev=getElev(e.wx,e.wy);
    }

    if(e.slowTimer>0)e.slowTimer-=dt;
    if(e.dotTimer>0){e.dotTimer-=dt;e.hp-=dt*4;}

    // Attack player (only if can attack elevation)
    if(canAttack(e.elev,pElev)&&d<e.r+player.r+8){
      e.attackCd-=dt;
      if(e.attackCd<=0){
        e.attackCd=1/e.attackRate;
        const dmg=e.dmg+Math.random()*4-2;
        player.hp=Math.max(0,player.hp-dmg);
        addLog(`${e.name} é€ æˆ ${Math.round(dmg)} ä¼¤å®³`,'dmg');
        updateInvGrid();
        if(player.hp<=0)killPlayer();
      }
    }else{e.attackCd=Math.max(0,e.attackCd-dt);}
  }
}

function updateProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    p.wx+=p.vx;p.wy+=p.vy;
    p.life-=dt;
    if(p.life<=0||isSolid(p.wx,p.wy)){projectiles.splice(i,1);continue;}

    for(const e of enemies){
      if(p.hit.has(e))continue;
      if(!canAttack(p.fromElev,e.elev))continue; // elevation blocks
      if(dist(p.wx,p.wy,e.wx,e.wy)<e.r+p.r){
        p.hit.add(e);
        e.hp-=p.dmg;
        if(p.slow)e.slowTimer=2.5;
        if(p.dot)e.dotTimer=3;
        if(p.vamp)player.hp=Math.min(player.maxHp,player.hp+p.dmg*.3);
        spawnParticles(e.wx,e.wy,p.color,5,2);
        if(p.aoe>0)enemies.forEach(e2=>{if(dist(p.wx,p.wy,e2.wx,e2.wy)<p.aoe+e2.r){e2.hp-=p.dmg*.5;spawnParticles(e2.wx,e2.wy,p.color,3,1.5);}});

        // Kill check
        enemies.filter(e2=>e2.hp<=0).forEach(e2=>{
          player.xp+=e2.xp;
          addLog(`å‡»æ€ ${e2.name} +${e2.xp}xp`,'imp');
          spawnParticles(e2.wx,e2.wy,e2.color,20,4);
          if(e2.dropWand){const w=WANDS[Math.floor(Math.random()*WANDS.length)];droppedWands.push({wx:e2.wx,wy:e2.wy,wand:w});addLog(`æ‰è½ ${w.name}!`,'loot');}
          enemies.splice(enemies.indexOf(e2),1);
          checkLevelUp();
        });

        if(!p.pierce){projectiles.splice(i,1);break;}
      }
    }
  }
}

function checkLevelUp(){
  while(player.xp>=player.xpNext){
    player.xp-=player.xpNext;player.level++;player.xpNext=Math.floor(player.xpNext*1.4);
    player.maxHp+=20;player.hp=Math.min(player.maxHp,player.hp+30);
    addLog(`LEVEL UP LV${player.level}! ç”Ÿå‘½+20`,'imp');
  }
  updateInvGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEATH / EXTRACT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function killPlayer(){
  if(gameState!=='playing')return;
  gameState='dead';
  player.inventory.forEach((item,i)=>{
    const a=(i/player.inventory.length)*Math.PI*2;
    droppedWands.push({wx:player.wx+Math.cos(a)*35,wy:player.wy+Math.sin(a)*35,wand:item.wand});
  });
  spawnParticles(player.wx,player.wy,'#e53e3e',30,6);
  const ds=document.getElementById('death-screen');
  ds.style.display='flex';
  document.getElementById('death-msg').textContent=`LV${player.level} é˜µäº¡ â€” èƒŒåŒ…ç‰©å“å·²æ‰è½ Â· å®¶å›­ä»“åº“å®‰å…¨`;
}

const extractPoint={wx:MAP_W-150,wy:MAP_H-150};

function checkExtract(){
  if(dist(player.wx,player.wy,extractPoint.wx,extractPoint.wy)<50){
    gameState='extracted';
    // Move inventory to stash
    const gained=player.inventory.map(i=>i.wand);
    gained.forEach(w=>stash.push({...w}));
    const es=document.getElementById('extract-screen');
    es.style.display='flex';
    document.getElementById('extract-summary').innerHTML=
      `æ’¤ç¦»æˆåŠŸï¼<br><br>`+
      (gained.length>0?gained.map(w=>`${w.icon} ${w.name}`).join('<br>'): 'ç©ºæ‰‹æ’¤ç¦»')+
      `<br><br>å·²å­˜å…¥ä»“åº“`;
  }
}

function goHomebase(){
  gameState='homebase';
  document.getElementById('death-screen').style.display='none';
  document.getElementById('extract-screen').style.display='none';
  document.getElementById('hud').style.display='none';
  document.getElementById('homebase').style.display='flex';
  document.getElementById('touch-btns').style.display='none';
  document.getElementById('joystick-base').style.display='none';
  refreshMarket();
  renderHomebase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOMEBASE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHomebase(){
  document.getElementById('hb-gold-val').textContent=gold;

  // Stash
  const sg=document.getElementById('storage-grid');
  sg.innerHTML='';
  const stashSlots=20;
  for(let i=0;i<stashSlots;i++){
    const slot=document.createElement('div');
    slot.className='storage-slot'+(stash[i]?' occupied':'')+(selectedStorage===i?' selected-storage':'');
    if(stash[i]){
      slot.innerHTML=`<div style="font-size:20px">${stash[i].icon}</div><div class="slot-name">${stash[i].name}</div>`;
    }
    slot.onclick=()=>{
      selectedStorage=(selectedStorage===i&&stash[i])?null:i;
      selectedLoadout=null;
      renderHomebase();
    };
    sg.appendChild(slot);
  }

  // Loadout
  const lg=document.getElementById('loadout-grid');
  lg.innerHTML='';
  const loadoutSlots=3;
  for(let i=0;i<loadoutSlots;i++){
    const slot=document.createElement('div');
    slot.className='loadout-slot'+(loadout[i]?' occupied':'')+(selectedLoadout===i?' selected-loadout':'');
    if(loadout[i]){
      slot.innerHTML=`<div style="font-size:20px">${loadout[i].icon}</div><div class="slot-name">${loadout[i].name}</div>`;
    }else{
      slot.innerHTML=`<div style="font-size:18px;color:#2a2a35">+</div><div class="slot-name">ç©ºæ§½ä½</div>`;
    }
    slot.onclick=()=>{
      selectedLoadout=(selectedLoadout===i)?null:i;
      selectedStorage=null;
      renderHomebase();
    };
    lg.appendChild(slot);
  }

  document.getElementById('btn-to-loadout').disabled=selectedStorage===null||!stash[selectedStorage];
  document.getElementById('btn-from-loadout').disabled=selectedLoadout===null||!loadout[selectedLoadout];

  // Market
  const ml=document.getElementById('market-list');
  ml.innerHTML='';
  WANDS.forEach(w=>{
    const price=marketPrices[w.id]||w.basePrice;
    const trend=price>w.basePrice?'up':'down';
    const trendIcon=trend==='up'?'â–²':'â–¼';
    const div=document.createElement('div');
    div.className='market-item';
    div.innerHTML=`
      <div class="mi-icon">${w.icon}</div>
      <div class="mi-info">
        <div class="mi-name">${w.name}</div>
        <div class="mi-price">
          <span class="price-val">â—ˆ${price}</span>
          <span class="price-trend ${trend}">${trendIcon}</span>
          Â· ${w.desc}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <button class="mi-action mi-sell" ${stash.some(s=>s.id===w.id)?'':'disabled'}
          onclick="sellWand('${w.id}',${price})">å–å‡º</button>
        <button class="mi-action mi-buy" ${gold>=price?'':'disabled'}
          onclick="buyWand('${w.id}',${price})">â—ˆ${price}</button>
      </div>
    `;
    ml.appendChild(div);
  });
}

function moveToLoadout(){
  if(selectedStorage===null||!stash[selectedStorage])return;
  const freeSlot=loadout.findIndex(s=>!s);
  if(freeSlot===-1){addLog('å‡ºå‘è£…å¤‡å·²æ»¡(3ä»¶)');return;}
  loadout[freeSlot]=stash.splice(selectedStorage,1)[0];
  selectedStorage=null;
  renderHomebase();
}

function moveFromLoadout(){
  if(selectedLoadout===null||!loadout[selectedLoadout])return;
  stash.push(loadout[selectedLoadout]);
  loadout[selectedLoadout]=null;
  selectedLoadout=null;
  renderHomebase();
}

function sellWand(id,price){
  const idx=stash.findIndex(s=>s.id===id);
  if(idx<0)return;
  stash.splice(idx,1);
  gold+=price;
  addLog(`å–å‡º â—ˆ${price}`,'imp');
  renderHomebase();
}

function buyWand(id,price){
  if(gold<price){addLog('é‡‘å¸ä¸è¶³','dmg');return;}
  if(stash.length>=20){addLog('ä»“åº“å·²æ»¡','dmg');return;}
  const w=WANDS.find(w=>w.id===id);
  stash.push({...w});
  gold-=price;
  addLog(`è´­ä¹° ${w.name}`,'loot');
  renderHomebase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAID START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRaid(){
  genMap();
  initPlayer();
  spawnChests();
  spawnEnemies();
  projectiles=[];particles=[];droppedWands=[];
  pickupTarget=null;pickupProgress=0;selectedInvIdx=null;
  frames=0;gameState='playing';

  document.getElementById('homebase').style.display='none';
  document.getElementById('hud').style.display='block';
  document.getElementById('death-screen').style.display='none';
  document.getElementById('extract-screen').style.display='none';
  document.getElementById('gold-display').textContent=`â—ˆ ${gold}`;

  if(isTouchDevice()){
    document.getElementById('joystick-base').style.display='block';
    document.getElementById('touch-btns').style.display='flex';
  }

  updateInvGrid();
  addLog('è¿›å…¥ FORSAKEN SANCTUM','imp');
  addLog('æœåˆ®Â·æ’¤ç¦»Â·å‹¿æ­»','info');
  selectedStorage=null;selectedLoadout=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const mmCanvas=document.getElementById('mm-canvas');
const mmCtx=mmCanvas.getContext('2d');

const FLOOR_COLORS=[['#12121a','#11111a','#131320'],['#181620','#161420','#1a1828'],['#1c2030','#1a1e2e','#202434']];
const WALL_COLORS=['#1e1e2e','#1a1a28','#222235'];
const ELEV_TINTS=['','rgba(255,220,100,0.06)','rgba(100,200,255,0.09)'];

function drawMap(){
  const sc=Math.max(0,Math.floor(cam.x/TILE)),ec=Math.min(COLS,Math.ceil((cam.x+W)/TILE)+1);
  const sr=Math.max(0,Math.floor(cam.y/TILE)),er=Math.min(ROWS,Math.ceil((cam.y+H)/TILE)+1);
  for(let r=sr;r<er;r++){
    for(let c=sc;c<ec;c++){
      const sx=c*TILE-cam.x,sy=r*TILE-cam.y;
      const t=tileMap[r][c],elv=elevMap[r][c]||0;
      if(t===1){
        ctx.fillStyle=WALL_COLORS[(r*3+c*7)%3];ctx.fillRect(sx,sy,TILE,TILE);
        ctx.fillStyle='rgba(255,255,255,0.025)';ctx.fillRect(sx,sy,TILE,3);
        ctx.strokeStyle='rgba(0,0,0,.35)';ctx.lineWidth=.5;ctx.strokeRect(sx,sy,TILE,TILE);
      }else{
        ctx.fillStyle=FLOOR_COLORS[elv][(r+c)%3];ctx.fillRect(sx,sy,TILE,TILE);
        if(ELEV_TINTS[elv]){ctx.fillStyle=ELEV_TINTS[elv];ctx.fillRect(sx,sy,TILE,TILE);}
        // Edge highlight for elevation change
        if(elv>0){
          ctx.strokeStyle='rgba(150,200,255,0.1)';ctx.lineWidth=1;ctx.strokeRect(sx+.5,sy+.5,TILE-1,TILE-1);
        }
        if((r+c)%5===0){ctx.fillStyle='rgba(255,255,255,0.015)';ctx.fillRect(sx+17,sy+17,5,5);}
      }
    }
  }
}

function drawExtractPoint(){
  const sx=extractPoint.wx-cam.x,sy=extractPoint.wy-cam.y;
  if(sx<-70||sx>W+70||sy<-70||sy>H+70)return;
  const p=.5+.5*Math.sin(frames*.08);
  ctx.save();
  ctx.globalAlpha=.12+p*.12;ctx.fillStyle='#4ade80';ctx.beginPath();ctx.arc(sx,sy,48+p*10,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;ctx.strokeStyle='#4ade80';ctx.lineWidth=2;ctx.shadowColor='#4ade80';ctx.shadowBlur=14;
  ctx.beginPath();ctx.arc(sx,sy,36,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='#4ade80';ctx.font='18px sans-serif';ctx.textAlign='center';ctx.fillText('â–²',sx,sy+6);
  ctx.font='8px "Share Tech Mono"';ctx.fillText('EXTRACT',sx,sy+20);
  ctx.restore();
}

function drawChests(){
  for(const ch of chests){
    if(ch.opened)continue;
    const sx=ch.wx-cam.x,sy=ch.wy-cam.y;
    if(sx<-30||sx>W+30||sy<-30||sy>H+30)continue;
    ch.gp+=.035;
    const g=.5+.5*Math.sin(ch.gp);
    const isTarget=pickupTarget===ch;
    ctx.save();
    ctx.shadowColor=ch.wand.color;ctx.shadowBlur=8+g*12;
    ctx.fillStyle='#13131f';ctx.fillRect(sx-11,sy-11,22,22);
    ctx.strokeStyle=isTarget?'#fbbf24':ch.wand.color;ctx.lineWidth=isTarget?2:1.5;ctx.strokeRect(sx-11,sy-11,22,22);
    ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillStyle=ch.wand.color;ctx.fillText(ch.wand.icon,sx,sy+5);
    ctx.restore();
    const d=dist(player.wx,player.wy,ch.wx,ch.wy);
    if(d<PICKUP_RANGE){
      ctx.fillStyle='#fbbf24';ctx.font='7px "Share Tech Mono"';ctx.textAlign='center';
      ctx.fillText(isTarget?'æ‹¾å–ä¸­...':'[ç‚¹å‡»æ‹¾å–]',sx,sy-16);
    }
  }
}

function drawDroppedWands(){
  for(const dw of droppedWands){
    const sx=dw.wx-cam.x,sy=dw.wy-cam.y;
    if(sx<-30||sx>W+30||sy<-30||sy>H+30)continue;
    const isTarget=pickupTarget===dw;
    ctx.save();ctx.shadowColor=dw.wand.color;ctx.shadowBlur=14;
    ctx.font='16px sans-serif';ctx.textAlign='center';ctx.fillStyle=dw.wand.color;ctx.fillText(dw.wand.icon,sx,sy+5);
    if(isTarget){ctx.strokeStyle='#fbbf24';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(sx,sy,16,0,Math.PI*2);ctx.stroke();}
    ctx.restore();
    if(dist(player.wx,player.wy,dw.wx,dw.wy)<PICKUP_RANGE){
      ctx.fillStyle='#fbbf24';ctx.font='7px "Share Tech Mono"';ctx.textAlign='center';
      ctx.fillText(isTarget?'æ‹¾å–ä¸­...':'[ç‚¹å‡»æ‹¾å–]',sx,sy-18);
    }
  }
}

function drawEnemies(){
  for(const e of enemies){
    const sx=e.wx-cam.x,sy=e.wy-cam.y;
    if(sx<-40||sx>W+40||sy<-40||sy>H+40)continue;
    const pElev=getElev(player.wx,player.wy);
    const canHitPlayer=canAttack(e.elev,pElev);

    ctx.save();
    ctx.shadowColor=e.color;ctx.shadowBlur=canHitPlayer?12:4;
    const bg=ctx.createRadialGradient(sx-3,sy-3,1,sx,sy,e.r);
    bg.addColorStop(0,e.color+'cc');bg.addColorStop(1,e.color+'44');
    ctx.fillStyle=bg;ctx.beginPath();ctx.arc(sx,sy,e.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=e.color;ctx.lineWidth=canHitPlayer?1.8:0.8;ctx.globalAlpha=canHitPlayer?1:0.5;ctx.stroke();
    ctx.restore();

    // Elevation badge
    if(e.elev>0){
      ctx.fillStyle=ELEV_COLORS[e.elev];ctx.font='7px "Share Tech Mono"';ctx.textAlign='center';
      ctx.fillText(['','MID','HIGH'][e.elev],sx,sy-e.r-4);
    }

    // HP bar
    if(e.hp<e.maxHp){
      const bw=e.r*2+6,bh=3,bx=sx-bw/2,by=sy-e.r-12;
      ctx.fillStyle='#1a1a22';ctx.fillRect(bx,by,bw,bh);
      ctx.fillStyle=e.color;ctx.fillRect(bx,by,bw*(e.hp/e.maxHp),bh);
    }
  }
}

function drawPlayer(){
  if(gameState==='dead')return;
  const sx=player.wx-cam.x,sy=player.wy-cam.y;
  const w=getEquipped();
  const color=w?w.color:'#e2e8f0';
  const pElev=getElev(player.wx,player.wy);

  ctx.save();
  ctx.shadowColor=color;ctx.shadowBlur=18;
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();ctx.arc(sx,sy,player.r+5,0,Math.PI*2);ctx.stroke();
  const g=ctx.createRadialGradient(sx-3,sy-3,1,sx,sy,player.r);
  g.addColorStop(0,'#f1f5f9');g.addColorStop(1,'#94a3b8');
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(sx,sy,player.r,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // Range ring
  const range=w?w.range:40;
  ctx.save();ctx.globalAlpha=.05;ctx.strokeStyle=color;ctx.lineWidth=1;ctx.setLineDash([4,6]);
  ctx.beginPath();ctx.arc(sx,sy,range,0,Math.PI*2);ctx.stroke();ctx.restore();

  // Elevation badge on player
  document.getElementById('elev-badge').textContent=ELEV_NAMES[pElev];
  document.getElementById('elev-badge').style.color=ELEV_COLORS[pElev];
}

function drawProjectiles(){
  for(const p of projectiles){
    const sx=p.wx-cam.x,sy=p.wy-cam.y;
    ctx.save();ctx.shadowColor=p.color;ctx.shadowBlur=12;
    ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(sx,sy,p.r,0,Math.PI*2);ctx.fill();ctx.restore();
  }
}

function drawParticles(){
  for(const p of particles){
    const sx=p.wx-cam.x,sy=p.wy-cam.y;
    ctx.save();ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(sx,sy,p.r*(p.life/p.maxLife),0,Math.PI*2);ctx.fill();ctx.restore();
  }
}

function drawMinimap(){
  const mm=mmCtx,mw=90,mh=90,sx=MAP_W/mw,sy2=MAP_H/mh;
  mm.fillStyle='#080810';mm.fillRect(0,0,mw,mh);
  // Elevation tint
  for(let r=0;r<ROWS;r+=3)for(let c=0;c<COLS;c+=3){
    if(!tileMap[r]||tileMap[r][c]===1)continue;
    const elv=elevMap[r][c]||0;
    mm.fillStyle=elv===2?'#1a2030':elv===1?'#141a20':'#101018';
    mm.fillRect(c*TILE/sx,r*TILE/sy2,3,3);
  }
  mm.fillStyle='#2a2a40';
  for(let r=0;r<ROWS;r+=2)for(let c=0;c<COLS;c+=2){if(tileMap[r]&&tileMap[r][c]===1)mm.fillRect(c*TILE/sx,r*TILE/sy2,2,2);}
  mm.fillStyle='#e53e3e';enemies.forEach(e=>mm.fillRect(e.wx/sx-1,e.wy/sy2-1,2,2));
  mm.fillStyle='#4ade80';mm.fillRect(extractPoint.wx/sx-3,extractPoint.wy/sy2-3,6,6);
  mm.fillStyle='#fbbf24';chests.forEach(ch=>{if(!ch.opened)mm.fillRect(ch.wx/sx-1,ch.wy/sy2-1,2,2);});
  mm.fillStyle='#fff';mm.beginPath();mm.arc(player.wx/sx,player.wy/sy2,3,0,Math.PI*2);mm.fill();
  mm.strokeStyle='#ffffff22';mm.lineWidth=.5;mm.strokeRect(cam.x/sx,cam.y/sy2,(W)/sx,H/sy2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const logEl=document.getElementById('log');
function addLog(msg,cls=''){
  const d=document.createElement('div');
  d.className='log-line'+(cls?' '+cls:'');d.textContent=msg;
  logEl.prepend(d);while(logEl.children.length>7)logEl.removeChild(logEl.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key.toLowerCase()==='f')tryStartPickup();
  if(e.key.toLowerCase()==='e')cycleWeapon();
  if(e.key===' '){e.preventDefault();}
});
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// Click on canvas to start pickup
canvas.addEventListener('click',e=>{
  if(gameState!=='playing')return;
  tryStartPickup();
});
canvas.addEventListener('touchstart',e=>{
  if(gameState!=='playing')return;
  e.preventDefault();
  tryStartPickup();
},{passive:false});

function cycleWeapon(){
  if(player.inventory.length===0)return;
  player.equippedIdx=((player.equippedIdx||0)+1)%player.inventory.length;
  addLog(`è£…å¤‡: ${player.inventory[player.equippedIdx].wand.name}`,'info');
  updateInvGrid();
}

// Camera
function updateCamera(){
  cam.x=player.wx-W/2;cam.y=player.wy-H/2;
  cam.x=Math.max(0,Math.min(MAP_W-W,cam.x));
  cam.y=Math.max(0,Math.min(MAP_H-H,cam.y));
}

// Util
function dist(ax,ay,bx,by){return Math.sqrt((ax-bx)**2+(ay-by)**2);}
function normalize(dx,dy){const d=Math.sqrt(dx*dx+dy*dy)||1;return[dx/d,dy/d];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOUCH JOYSTICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initJoystick(){
  const base=document.getElementById('joystick-base');
  const knob=document.getElementById('joystick-knob');
  function center(){
    const r=base.getBoundingClientRect();
    const ar=document.getElementById('app').getBoundingClientRect();
    const sc=ar.width/900;
    return{x:(r.left+r.width/2-ar.left)/sc,y:(r.top+r.height/2-ar.top)/sc};
  }
  base.addEventListener('touchstart',e=>{e.preventDefault();joystickActive=true;joystickOrigin=center();},{passive:false});
  base.addEventListener('touchmove',e=>{
    e.preventDefault();if(!joystickActive)return;
    const t=e.touches[0];
    const ar=document.getElementById('app').getBoundingClientRect();
    const sc=ar.width/900;
    let dx=(t.clientX-ar.left)/sc-joystickOrigin.x;
    let dy=(t.clientY-ar.top)/sc-joystickOrigin.y;
    const d=Math.sqrt(dx*dx+dy*dy);
    if(d>JOYSTICK_MAX){dx=dx/d*JOYSTICK_MAX;dy=dy/d*JOYSTICK_MAX;}
    joystickDelta={x:dx,y:dy};
    knob.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
  },{passive:false});
  const end=()=>{joystickActive=false;joystickDelta={x:0,y:0};knob.style.transform='translate(-50%,-50%)';};
  base.addEventListener('touchend',end,{passive:false});
  base.addEventListener('touchcancel',end,{passive:false});
}

function getTouchMove(){
  if(!joystickActive)return[0,0];
  return[joystickDelta.x/JOYSTICK_MAX,joystickDelta.y/JOYSTICK_MAX];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scaleApp(){
  const app=document.getElementById('app');
  const sc=Math.min(window.innerWidth/900,window.innerHeight/600);
  app.style.transform=`scale(${sc})`;
  app.style.left=((window.innerWidth-900*sc)/2)+'px';
  app.style.top=((window.innerHeight-600*sc)/2)+'px';
}
scaleApp();window.addEventListener('resize',scaleApp);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  const dt=Math.min((ts-lastTime)/1000,.05);lastTime=ts;frames++;

  if(gameState==='playing'){
    let dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy-=1;
    if(keys['s']||keys['arrowdown'])dy+=1;
    if(keys['a']||keys['arrowleft'])dx-=1;
    if(keys['d']||keys['arrowright'])dx+=1;
    const[tdx,tdy]=getTouchMove();dx+=tdx;dy+=tdy;
    if(dx||dy){
      const[nx,ny]=normalize(dx,dy);
      const nx2=player.wx+nx*player.spd,ny2=player.wy+ny*player.spd;
      if(!isSolid(nx2,player.wy))player.wx=nx2;
      if(!isSolid(player.wx,ny2))player.wy=ny2;
    }

    playerShoot(dt);
    updateEnemies(dt);
    updateProjectiles(dt);
    updatePickup(dt);

    for(const p of particles){p.wx+=p.vx;p.wy+=p.vy;p.vy+=.04;p.life-=dt*.9;}
    particles=particles.filter(p=>p.life>0);

    updateCamera();
    checkExtract();

    // Respawn
    if(enemies.length<10){
      for(let i=0;i<3;i++){
        let wx,wy,tries=0;
        do{wx=100+Math.random()*(MAP_W-200);wy=100+Math.random()*(MAP_H-200);tries++;}
        while((isSolid(wx,wy)||dist(wx,wy,player.wx,player.wy)<280)&&tries<40);
        const t=ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
        enemies.push({wx,wy,hp:t.hp,maxHp:t.hp,spd:t.spd,dmg:t.dmg,color:t.color,r:t.r,xp:t.xp,name:t.name,
          elev:getElev(wx,wy),attackCd:0,attackRate:1.1,aggroRange:200,wanderAngle:Math.random()*Math.PI*2,
          dropWand:Math.random()<.12,slowTimer:0,dotTimer:0,ranged:t.ranged||false,range:t.range||60,phase:0});
      }
    }
  }else if(gameState==='dead'){
    for(const p of particles){p.wx+=p.vx;p.wy+=p.vy;p.vy+=.05;p.life-=dt*.5;}
    particles=particles.filter(p=>p.life>0);
    updateCamera();
  }

  if(gameState==='playing'||gameState==='dead'){
    ctx.clearRect(0,0,W,H);
    drawMap();drawExtractPoint();drawChests();drawDroppedWands();
    drawParticles();drawEnemies();drawProjectiles();drawPlayer();

    // Vignette
    const vig=ctx.createRadialGradient(W/2,H/2,H*.28,W/2,H/2,H*.72);
    vig.addColorStop(0,'transparent');vig.addColorStop(1,'rgba(0,0,0,.6)');
    ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);

    // Low HP
    if(gameState==='playing'&&player.hp<player.maxHp*.3){
      ctx.save();ctx.globalAlpha=.1+.08*Math.sin(frames*.3);ctx.fillStyle='#e53e3e';ctx.fillRect(0,0,W,H);ctx.restore();
    }
    drawMinimap();
  }

  requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
refreshMarket();
initJoystick();
goHomebase(); // Start at homebase
requestAnimationFrame(ts=>{lastTime=ts;requestAnimationFrame(loop);});
</script>
</body>
</html>
