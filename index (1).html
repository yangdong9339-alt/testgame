<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ARCANE EXTRACTION v2</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:#ebe9e0;display:flex;align-items:center;justify-content:center;width:100vw;height:100vh;font-family:'Share Tech Mono',monospace;overflow:hidden;color:#1a1a18;touch-action:none}
#app{position:absolute;width:900px;height:600px;background:#f7f6f0;transform-origin:top left;box-shadow:0 8px 40px rgba(0,0,0,0.18)}
canvas{display:block}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;inset:0;pointer-events:none}
#top-bar{position:absolute;top:0;left:0;right:0;height:38px;background:linear-gradient(180deg,rgba(247,246,240,0.92),transparent);display:flex;align-items:center;padding:0 12px;gap:16px;border-bottom:1px solid #e5e4de}
#zone-label{font-family:'Cinzel',serif;font-size:10px;color:#9a9488;letter-spacing:3px;flex:1;text-align:center}
.stat-block{display:flex;flex-direction:column;gap:2px;min-width:120px}
.bar-label{font-size:7px;color:#9a9488;letter-spacing:2px}
.bar-bg{height:6px;background:#e5e4de;border:1px solid #d0cfc8;position:relative;border-radius:2px}
.bar-fill{height:100%;border-radius:2px;transition:width .15s}
#hp-fill{background:linear-gradient(90deg,#dc2626,#f87171)}
#xp-fill{background:linear-gradient(90deg,#7c3aed,#a78bfa)}
#gold-display{font-size:11px;color:#d97706;white-space:nowrap;font-weight:bold}

#log{position:absolute;top:44px;left:10px;width:200px;max-height:72px;overflow:hidden;display:flex;flex-direction:column;gap:1px;pointer-events:none}
.log-line{font-size:8px;color:#9a9488;line-height:1.4;animation:fadeIn .3s}
.log-line.imp{color:#d97706}.log-line.dmg{color:#dc2626}.log-line.loot{color:#15803d}.log-line.info{color:#1d4ed8}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}

/* Minimap */
#minimap{position:absolute;top:10px;right:10px;width:90px;height:90px;border:1px solid #d0cfc8;background:#e5e4de;pointer-events:none;border-radius:2px}

/* Elevation indicator */
#elev-badge{position:absolute;top:44px;right:10px;font-size:8px;color:#7c3aed;letter-spacing:2px;text-align:right;pointer-events:none;margin-top:96px}

/* Pickup bar */
#pickup-bar-wrap{position:absolute;bottom:130px;left:50%;transform:translateX(-50%);width:160px;display:none;flex-direction:column;align-items:center;gap:4px;pointer-events:none}
#pickup-label{font-size:8px;color:#d97706;letter-spacing:2px}
#pickup-bg{width:160px;height:8px;background:#e5e4de;border:1px solid #d0cfc8;border-radius:2px}
#pickup-fill{height:100%;background:linear-gradient(90deg,#d97706,#f59e0b);width:0%;transition:width .05s linear;border-radius:2px}

/* Equipped weapon */
#weapon-hud{position:absolute;bottom:10px;left:10px;padding:6px 10px;border:1px solid #d0cfc8;background:rgba(247,246,240,0.95);pointer-events:none;min-width:110px;border-radius:4px}
#weapon-name{font-size:9px;color:#d97706;font-family:'Cinzel',serif;margin-bottom:2px}
#weapon-stats{font-size:8px;color:#6b6860;line-height:1.5}

/* â”€â”€ GRID INVENTORY PANEL â”€â”€ */
#inv-panel{position:absolute;bottom:10px;right:10px;background:rgba(247,246,240,0.97);border:1px solid #d0cfc8;padding:8px;width:220px;pointer-events:all;border-radius:6px;box-shadow:0 2px 12px rgba(0,0,0,0.1)}
#inv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
#inv-title{font-size:8px;color:#9a9488;letter-spacing:2px}
#inv-weight{font-size:8px;color:#9a9488}
#inv-grid{display:grid;grid-template-columns:repeat(6,30px);grid-template-rows:repeat(4,30px);gap:2px;position:relative}
.inv-cell{width:30px;height:30px;border:1px solid #e5e4de;background:#f0efe9;position:relative;border-radius:2px}
.inv-cell.occupied{border-color:#d0cfc8}
.inv-item-block{position:absolute;border:1px solid;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:14px;cursor:pointer;z-index:2;gap:0px;border-radius:2px}
.inv-item-block:hover{filter:brightness(0.95)}
.inv-item-block.selected{box-shadow:0 0 0 2px #d97706}
.inv-item-block.is-equipped{box-shadow:0 0 0 2px #15803d}
.inv-item-name{font-size:5px;color:#1a1a1888;line-height:1;padding:0 1px;text-align:center;overflow:hidden;max-width:100%}
#inv-actions{display:flex;gap:4px;margin-top:6px}
.inv-btn{flex:1;padding:4px;font-family:'Share Tech Mono',monospace;font-size:8px;background:none;border:1px solid #d0cfc8;color:#1a1a18;cursor:pointer;letter-spacing:1px;border-radius:3px}
.inv-btn:hover{border-color:#d97706;color:#d97706}
.inv-btn:disabled{opacity:.3;cursor:default}

/* â”€â”€ HOMEBASE SCREEN â”€â”€ */
#homebase{position:absolute;inset:0;background:#f7f6f0;display:none;flex-direction:column}
#hb-header{background:#ffffff;border-bottom:1px solid #e5e4de;padding:12px 20px;display:flex;align-items:center;gap:20px}
#hb-title{font-family:'Cinzel',serif;font-size:16px;color:#1a1a18;letter-spacing:4px}
#hb-gold{font-size:12px;color:#d97706;font-weight:bold}
#hb-btn-raid{margin-left:auto;padding:8px 20px;background:#d97706;border:none;color:#ffffff;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:2px;border-radius:4px}
#hb-btn-raid:hover{background:#b45309}
#hb-body{display:flex;flex:1;overflow:hidden}
#hb-storage{flex:1;padding:16px;border-right:1px solid #e5e4de;overflow-y:auto;background:#f7f6f0}
#hb-market{width:280px;padding:16px;overflow-y:auto;background:#ffffff}
.hb-section-title{font-size:9px;color:#9a9488;letter-spacing:3px;margin-bottom:10px;border-bottom:1px solid #e5e4de;padding-bottom:4px;text-transform:uppercase}
#storage-grid{display:grid;grid-template-columns:repeat(5,54px);gap:4px}
.storage-slot{width:54px;height:54px;border:1px solid #e5e4de;background:#f0efe9;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:18px;cursor:pointer;position:relative;border-radius:4px}
.storage-slot:hover{border-color:#d0cfc8;background:#ebe9e0}
.storage-slot .slot-name{font-size:6px;color:#9a9488;text-align:center;position:absolute;bottom:3px;width:100%;padding:0 2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.storage-slot.occupied{border-color:#d0cfc8;background:#ffffff}
.storage-slot.selected-storage{border-color:#d97706!important;box-shadow:0 0 0 2px #d9770644}
#market-list{display:flex;flex-direction:column;gap:4px}
.market-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #e5e4de;background:#f7f6f0;cursor:pointer;border-radius:4px}
.market-item:hover{border-color:#d0cfc8;background:#f0efe9}
.market-item .mi-icon{font-size:16px;width:24px;text-align:center}
.market-item .mi-info{flex:1}
.market-item .mi-name{font-size:8px;color:#1a1a18}
.market-item .mi-price{font-size:7px;color:#6b6860;margin-top:2px}
.market-item .mi-price .price-val{color:#d97706;font-weight:bold}
.market-item .mi-price .price-trend{font-size:6px}
.market-item .mi-price .up{color:#15803d}.market-item .mi-price .down{color:#dc2626}
.market-item .mi-action{font-size:7px;padding:3px 8px;background:none;border:1px solid;cursor:pointer;font-family:'Share Tech Mono',monospace;border-radius:3px}
.mi-sell{border-color:#15803d88;color:#15803d}.mi-sell:hover{background:#15803d15}
.mi-buy{border-color:#7c3aed88;color:#7c3aed}.mi-buy:hover{background:#7c3aed15}
.mi-sell:disabled,.mi-buy:disabled{opacity:.3;cursor:default}
#hb-storage-actions{display:flex;gap:6px;margin-top:8px}
.hb-action-btn{padding:4px 10px;background:none;border:1px solid #d0cfc8;color:#1a1a18;font-family:'Share Tech Mono',monospace;font-size:8px;cursor:pointer;border-radius:3px}
.hb-action-btn:hover{border-color:#d97706;color:#d97706}
.hb-action-btn:disabled{opacity:.3;cursor:default}

/* â”€â”€ HOMEBASE LOADOUT REDESIGN â”€â”€ */
#hb-body{display:flex;flex:1;overflow:hidden}
#hb-storage{width:280px;padding:12px;border-right:1px solid #e5e4de;overflow-y:auto;flex-shrink:0;background:#f7f6f0}
#hb-loadout{width:260px;padding:12px;border-right:1px solid #e5e4de;overflow-y:auto;flex-shrink:0;background:#faf9f5}
#hb-market{flex:1;padding:12px;overflow-y:auto;background:#ffffff}

/* Equipment slots */
#equip-slots-row{display:flex;gap:8px;flex-wrap:wrap}
.equip-slot-wrap{display:flex;flex-direction:column;align-items:center;gap:3px}
.equip-slot-label{font-size:6px;color:#9a9488;letter-spacing:1px;text-transform:uppercase}
.equip-slot{width:52px;height:52px;border:1px solid #e5e4de;background:#f7f6f0;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;border-radius:6px}
.equip-slot:hover{border-color:#d0cfc8;background:#ebe9e0}
.equip-slot.filled{border-color:#15803d44;background:#f0fdf4}
.equip-slot.selected{border-color:#d97706;box-shadow:0 0 0 2px #d9770622}
.equip-slot .eslot-empty{font-size:18px;color:#d0cfc8}
.equip-slot .eslot-icon{font-size:20px;line-height:1}
.equip-slot .eslot-name{font-size:5px;color:#15803d;text-align:center;padding:0 2px;line-height:1.2;overflow:hidden;max-width:50px}
.equip-slot .eslot-del{position:absolute;top:2px;right:3px;font-size:6px;color:#c0beb6;cursor:pointer}
.equip-slot .eslot-del:hover{color:#dc2626}

/* Ammo slots */
#ammo-slots-row{display:flex;gap:6px;flex-wrap:wrap}
.ammo-slot{width:52px;height:52px;border:1px dashed #d0cfc8;background:#f7f6f0;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;gap:2px;border-radius:6px}
.ammo-slot:hover{border-color:#9a9488}
.ammo-slot.filled{border-style:solid;border-color:#7c3aed44;background:#faf5ff}
.ammo-slot.selected{border-color:#d97706;box-shadow:0 0 0 2px #d9770622}
.ammo-slot .aslot-empty{font-size:14px;color:#d0cfc8}
.ammo-slot .aslot-icon{font-size:18px;line-height:1}
.ammo-slot .aslot-count{font-size:9px;font-weight:bold;line-height:1}
.ammo-slot .aslot-name{font-size:5px;color:#6b6860;text-align:center;padding:0 1px;line-height:1.1}
.ammo-slot .aslot-del{position:absolute;top:2px;right:3px;font-size:6px;color:#c0beb6;cursor:pointer}
.ammo-slot .aslot-del:hover{color:#dc2626}

/* Loadout bag grid */
#loadout-grid{display:grid;grid-template-columns:repeat(4,52px);gap:4px;margin-top:6px}
.loadout-slot{width:52px;height:52px;border:1px dashed #d0cfc8;background:#f7f6f0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px;cursor:pointer;position:relative;border-radius:4px}
.loadout-slot:hover{border-color:#9a9488;background:#ebe9e0}
.loadout-slot .slot-name{font-size:5px;color:#9a9488;position:absolute;bottom:3px;width:100%;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.loadout-slot.occupied{border-style:solid;border-color:#d0cfc8;background:#ffffff}
.loadout-slot.selected-loadout{border-color:#d97706!important}



/* â”€â”€ IN-RAID EQUIPMENT ROW â”€â”€ */
#inv-equip-row{display:flex;gap:3px;margin-bottom:5px}
.inv-eq-slot{width:46px;height:46px;border:1px solid #d0cfc8;background:#f0efe9;border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px;position:relative;flex-shrink:0}
.inv-eq-slot .ieq-icon{font-size:18px;line-height:1}
.inv-eq-slot .ieq-label{font-size:5px;color:#9a9488;letter-spacing:1px;position:absolute;bottom:2px}
.inv-eq-slot.filled{border-color:#15803d66;background:#f0fdf4}
/* â”€â”€ OVERLAY SCREENS â”€â”€ */
.overlay-screen{position:absolute;inset:0;background:rgba(247,246,240,0.96);display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.overlay-screen h1{font-family:'Cinzel',serif;letter-spacing:6px;color:#1a1a18}
.overlay-screen p{font-size:10px;color:#6b6860}
.overlay-screen button{padding:8px 24px;background:#1a1a18;border:none;color:#f7f6f0;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:2px;border-radius:4px}
.overlay-screen button:hover{background:#333}
#death-screen h1{color:#dc2626}
#extract-screen h1{color:#15803d;font-size:22px}
#extract-screen .summary{font-size:9px;color:#6b6860;text-align:center;line-height:2.2}
#extract-screen button{background:#15803d}

/* â”€â”€ TOUCH CONTROLS â”€â”€ */
#touch-zone{position:absolute;inset:0;pointer-events:none}
#joystick-base{position:absolute;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.1);bottom:100px;left:30px;pointer-events:all;display:none}
#joystick-knob{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.3);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
#touch-btns{position:absolute;bottom:100px;right:10px;display:none;flex-direction:column;gap:8px;pointer-events:all}
.tbtn{width:60px;height:60px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:7px;border:1.5px solid;cursor:pointer;letter-spacing:1px;gap:2px}
#tbtn-pickup{background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.4);color:#fbbf24}
#tbtn-cycle{background:rgba(99,102,241,.12);border-color:rgba(99,102,241,.4);color:#a5b4fc}
#tbtn-home{background:rgba(74,222,128,.12);border-color:rgba(74,222,128,.4);color:#4ade80}
.tbtn-icon{font-size:18px;line-height:1}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#login-screen{position:absolute;inset:0;background:#f7f6f0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:100}
#login-title{font-family:'Cinzel',serif;font-size:26px;color:#1a1a18;letter-spacing:8px}
#login-sub{font-size:8px;color:#9a9488;letter-spacing:3px}
#login-box{background:#ffffff;border:1px solid #e5e4de;padding:22px 28px;width:300px;display:flex;flex-direction:column;gap:10px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
#login-box input{background:#f7f6f0;border:1px solid #d0cfc8;color:#1a1a18;padding:8px 10px;font-family:'Share Tech Mono',monospace;font-size:11px;outline:none;width:100%;box-sizing:border-box;border-radius:4px}
#login-box input:focus{border-color:#d97706;outline:none}
#login-box input::placeholder{color:#c0beb6}
.lbtn{padding:9px;background:#1a1a18;border:none;color:#f7f6f0;font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:2px;width:100%;border-radius:4px}
.lbtn:hover{background:#333}
.lbtn.primary{background:#f0efe9;color:#6b6860;border:1px solid #d0cfc8}
#login-msg{font-size:8px;text-align:center;min-height:12px;letter-spacing:1px;color:#9a9488}
#login-msg.err{color:#dc2626}
#login-msg.ok{color:#15803d}
#login-switch{font-size:7px;color:#9a9488;text-align:center;cursor:pointer;letter-spacing:1px;margin-top:2px}
#login-switch:hover{color:#d97706}

/* â”€â”€ SAVE SLOTS SCREEN â”€â”€ */
#saves-screen{position:absolute;inset:0;background:#f7f6f0;display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:99}
#saves-title{font-family:'Cinzel',serif;font-size:18px;color:#1a1a18;letter-spacing:6px}
#saves-subtitle{font-size:7px;color:#9a9488;letter-spacing:2px}
#saves-list{display:flex;gap:12px}
.sv{width:170px;min-height:155px;border:1px solid #e5e4de;background:#ffffff;padding:14px;display:flex;flex-direction:column;gap:6px;cursor:pointer;position:relative;transition:border-color .15s;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.sv:hover{border-color:#d97706}
.sv .sv-n{font-size:7px;color:#9a9488;letter-spacing:2px}
.sv .sv-title{font-size:10px;color:#1a1a18;font-family:'Cinzel',serif;margin-top:2px}
.sv .sv-stat{font-size:7px;color:#6b6860;line-height:1.9}
.sv .sv-stat span{color:#1a1a18;font-weight:bold}
.sv .sv-time{font-size:6px;color:#9a9488;margin-top:auto;padding-top:6px;border-top:1px solid #e5e4de}
.sv.empty{align-items:center;justify-content:center;border-style:dashed;background:#f7f6f0}
.sv.empty:hover{border-color:#d97706}
.sv .sv-empty-icon{font-size:26px;color:#d0cfc8;margin-bottom:6px}
.sv .sv-empty-txt{font-size:7px;color:#9a9488;letter-spacing:2px}
.sv .sv-del{position:absolute;top:6px;right:8px;font-size:7px;color:#c0beb6;cursor:pointer;padding:2px 4px;border:1px solid transparent;border-radius:2px}
.sv .sv-del:hover{color:#dc2626;border-color:#dc262644}
#saves-loading{font-size:8px;color:#9a9488;letter-spacing:3px;animation:fadeIn .5s}

/* â”€â”€ USER BAR (top right in homebase) â”€â”€ */
#user-bar{display:none;align-items:center;gap:8px;font-size:7px;color:#6b6860}
#user-email{color:#9a9488;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#btn-logout{background:none;border:1px solid #d0cfc8;color:#6b6860;font-family:'Share Tech Mono',monospace;font-size:7px;padding:3px 7px;cursor:pointer;letter-spacing:1px;border-radius:3px}
#btn-logout:hover{border-color:#dc2626;color:#dc2626}
#btn-save-now{background:none;border:1px solid #15803d66;color:#15803d;font-family:'Share Tech Mono',monospace;font-size:7px;padding:3px 7px;cursor:pointer;letter-spacing:1px;border-radius:3px}
#btn-save-now:hover{border-color:#15803d;background:#15803d15}
#save-status{font-size:7px;color:#9a9488;min-width:60px;text-align:right}
</style>
</head>
<body>
<div id="app">
  <canvas id="canvas" width="900" height="600"></canvas>

  <!-- IN-RAID HUD -->
  <div id="hud">
    <div id="top-bar">
      <div class="stat-block">
        <div class="bar-label">VITALITY</div>
        <div class="bar-bg" style="width:120px"><div class="bar-fill" id="hp-fill" style="width:100%"></div></div>
      </div>
      <div class="stat-block">
        <div class="bar-label">XP</div>
        <div class="bar-bg" style="width:80px"><div class="bar-fill" id="xp-fill" style="width:0%"></div></div>
      </div>
      <div id="zone-label">FORSAKEN SANCTUM</div>
      <div id="gold-display">â—ˆ 0</div>
    </div>
    <div id="log"></div>
    <div id="minimap"><canvas id="mm-canvas" width="90" height="90"></canvas></div>
    <div id="elev-badge"></div>
    <div id="pickup-bar-wrap">
      <div id="pickup-label">LOOTING...</div>
      <div id="pickup-bg"><div id="pickup-fill"></div></div>
    </div>
    <div id="weapon-hud">
      <div id="weapon-name">BARE HANDS</div>
      <div id="weapon-stats">DMG 5â€“8 Â· RNG 40</div>
      <div id="ammo-hud" style="font-size:8px;color:#a855f7;margin-top:3px"></div>
    </div>
    <div id="inv-panel">
      <div id="inv-header">
        <div id="inv-title">BACKPACK</div>
        <div id="inv-weight">0 / 6 slots</div>
      </div>
      <div id="inv-grid"></div>
      <div id="inv-actions">
        <button class="inv-btn" id="btn-equip" disabled onclick="equipSelected()">EQUIP</button>
        <button class="inv-btn" id="btn-sell-inv" disabled onclick="sellFromInventory()" style="color:#15803d">SELL</button>
        <button class="inv-btn" id="btn-drop" disabled onclick="dropSelected()">DROP</button>
      </div>
    </div>
  </div>

  <!-- PICKUP PROGRESS (canvas overlay) -->

  <!-- DEATH / EXTRACT OVERLAYS -->
  <div class="overlay-screen" id="death-screen">
    <h1>SLAIN</h1>
    <p id="death-msg"></p>
    <button onclick="goHomebase()">RETURN TO BASE</button>
  </div>
  <div class="overlay-screen" id="extract-screen">
    <h1>EXTRACTED</h1>
    <div class="summary" id="extract-summary"></div>
    <button onclick="goHomebase()">RETURN TO BASE</button>
  </div>

  <!-- HOMEBASE -->
  <div id="homebase">
    <div id="hb-header">
      <div id="hb-title">HOME BASE</div>
      <div id="hb-gold">â—ˆ <span id="hb-gold-val">0</span></div>
      <div id="user-bar">
        <div id="user-email"></div>
        <button id="btn-save-now" onclick="saveGame()">ğŸ’¾ SAVE</button>
        <div id="save-status"></div>
        <button id="btn-logout" onclick="doLogout()">LOGOUT</button>
      </div>
      <button id="hb-btn-raid" onclick="startRaid()">â–¶ RAID</button>
    </div>
    <div id="hb-body">
      <!-- LEFT: Stash -->
      <div id="hb-storage">
        <div class="hb-section-title">STASH <span id="loadout-hint" style="color:#fbbf24;font-size:7px;margin-left:8px"></span></div>
        <div id="storage-grid"></div>
      </div>
      <!-- CENTER: Loadout (equipment slots + bag) -->
      <div id="hb-loadout">
        <div class="hb-section-title">LOADOUT Â· å‡ºå‡»é…ç½®</div>
        <!-- Equipment slots row -->
        <div id="equip-slots-row">
          <div class="equip-slot-wrap">
            <div class="equip-slot-label">æ­¦å™¨</div>
            <div class="equip-slot" id="eslot-weapon" data-type="wand" onclick="clickEquipSlot('weapon')">
              <span class="eslot-empty">âš”</span>
            </div>
          </div>
          <div class="equip-slot-wrap">
            <div class="equip-slot-label">é˜²å…·</div>
            <div class="equip-slot" id="eslot-armor" data-type="armor" onclick="clickEquipSlot('armor')">
              <span class="eslot-empty">ğŸ›¡</span>
            </div>
          </div>
          <div class="equip-slot-wrap">
            <div class="equip-slot-label">é‹å­</div>
            <div class="equip-slot" id="eslot-boots" data-type="boots" onclick="clickEquipSlot('boots')">
              <span class="eslot-empty">ğŸ‘¢</span>
            </div>
          </div>
          <div class="equip-slot-wrap">
            <div class="equip-slot-label">é¥°å“</div>
            <div class="equip-slot" id="eslot-acc" data-type="acc" onclick="clickEquipSlot('acc')">
              <span class="eslot-empty">ğŸ’</span>
            </div>
          </div>
        </div>
        <!-- Ammo slots -->
        <div class="hb-section-title" style="margin-top:10px">çµæ™¶ Â· å¼¹è¯</div>
        <div id="ammo-slots-row">
          <div class="ammo-slot" id="aslot-0" onclick="clickAmmoSlot(0)"><span class="aslot-empty">+</span></div>
          <div class="ammo-slot" id="aslot-1" onclick="clickAmmoSlot(1)"><span class="aslot-empty">+</span></div>
          <div class="ammo-slot" id="aslot-2" onclick="clickAmmoSlot(2)"><span class="aslot-empty">+</span></div>
          <div class="ammo-slot" id="aslot-3" onclick="clickAmmoSlot(3)"><span class="aslot-empty">+</span></div>
        </div>
        <div style="font-size:6px;color:#2a2a3a;margin-top:4px">ç‚¹ä»“åº“ç‰©å“ â†’ ç‚¹æ§½ä½æ”¾å…¥ Â· ç‚¹å·²å æ§½ä½é€€å›</div>
        <!-- Bag loadout -->
        <div class="hb-section-title" style="margin-top:10px">èƒŒåŒ…å¸¦å…¥ (æœ€å¤š4æ ¼)</div>
        <div id="loadout-grid"></div>
        <div style="font-size:6px;color:#2a2a3a;margin-top:4px">ç‚¹å‡»å·²æ”¾å…¥ç‰©å“å¯é€€å›ä»“åº“</div>
      </div>
      <!-- RIGHT: Market -->
      <div id="hb-market">
        <div class="hb-section-title">ARCANE MARKET</div>
        <div id="market-list"></div>
      </div>
    </div>
  </div>


  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div id="login-title">ARCANE EXTRACTION</div>
    <div id="login-sub">FORSAKEN SANCTUM Â· EARLY ACCESS</div>
    <div id="login-box">
      <input type="email" id="login-email" placeholder="EMAIL ADDRESS" autocomplete="email"/>
      <input type="password" id="login-pass" placeholder="PASSWORD" autocomplete="current-password"/>
      <button class="lbtn primary" onclick="doLogin()">â–¶ LOGIN</button>
      <button class="lbtn" onclick="doSignup()">+ CREATE ACCOUNT</button>
      <div id="login-msg"></div>
      <div id="login-switch" onclick="toggleLoginMode()">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹æ­¤æ³¨å†Œ</div>
    </div>
  </div>

  <!-- SAVE SLOTS SCREEN -->
  <div id="saves-screen">
    <div id="saves-title">SELECT SAVE</div>
    <div id="saves-subtitle">é€‰æ‹©å­˜æ¡£ä½ç½®</div>
    <div id="saves-list"><div id="saves-loading">LOADING...</div></div>
  </div>
  <!-- TOUCH -->
  <div id="touch-zone">
    <div id="joystick-base"><div id="joystick-knob"></div></div>
    <div id="touch-btns">
      <div class="tbtn" id="tbtn-pickup" ontouchstart="startPickupTouch(event)"><div class="tbtn-icon">â—†</div>æ‹¾å–</div>
      <div class="tbtn" id="tbtn-cycle" ontouchstart="cycleWeapon()"><div class="tbtn-icon">âš¡</div>åˆ‡æ¢</div>
      <div class="tbtn" id="tbtn-home" ontouchstart="goHomebase()"><div class="tbtn-icon">âŒ‚</div>æ’¤ç¦»</div>
    </div>
  </div>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL='https://vvhoznnsywkfxbijzwvk.supabase.co';
const SUPA_KEY='sb_publishable_7opFB4gcVM8Vw0V7ASmGKA_dpBgLaJx';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);

let currentUser=null;
let currentSlot=null;
let saveTimer=null;
let loginMode='login'; // 'login' | 'signup'

// â”€â”€ AUTH â”€â”€
function toggleLoginMode(){
  loginMode=loginMode==='login'?'signup':'login';
  document.getElementById('login-switch').textContent=
    loginMode==='login'?'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹æ­¤æ³¨å†Œ':'å·²æœ‰è´¦å·ï¼Ÿç‚¹æ­¤ç™»å½•';
  setLoginMsg('');
}

function setLoginMsg(msg,type=''){
  const el=document.getElementById('login-msg');
  el.textContent=msg;
  el.className=type;
}

async function doLogin(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  if(!email||!pass){setLoginMsg('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ','err');return;}
  setLoginMsg('ç™»å½•ä¸­...','');
  const {data,error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){setLoginMsg(error.message==='Invalid login credentials'?'é‚®ç®±æˆ–å¯†ç é”™è¯¯':error.message,'err');return;}
  currentUser=data.user;
  onLoggedIn();
}

async function doSignup(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  if(!email||!pass){setLoginMsg('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ','err');return;}
  if(pass.length<6){setLoginMsg('å¯†ç è‡³å°‘6ä½','err');return;}
  setLoginMsg('æ³¨å†Œä¸­...','');
  const {data,error}=await sb.auth.signUp({email,password:pass});
  if(error){setLoginMsg(error.message,'err');return;}
  if(data.user&&!data.session){
    setLoginMsg('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯é“¾æ¥','ok');return;
  }
  currentUser=data.user;
  onLoggedIn();
}

async function doLogout(){
  await sb.auth.signOut();
  currentUser=null;currentSlot=null;
  gold=200;stash=[];loadout=[];
  equipSlots={weapon:null,armor:null,boots:null,acc:null};
  ammoSlots=[null,null,null,null];
  bagLoadout=[];
  document.getElementById('homebase').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('user-bar').style.display='none';
  setLoginMsg('å·²é€€å‡ºç™»å½•','ok');
}

function onLoggedIn(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('user-email').textContent=currentUser.email;
  document.getElementById('user-bar').style.display='flex';
  showSaves();
}

// â”€â”€ SAVE SLOTS â”€â”€
async function showSaves(){
  const screen=document.getElementById('saves-screen');
  screen.style.display='flex';
  document.getElementById('saves-list').innerHTML='<div id="saves-loading">LOADING...</div>';

  const {data,error}=await sb.from('saves').select('*').eq('user_id',currentUser.id).order('slot');
  const slotMap={};
  if(data) data.forEach(s=>slotMap[s.slot]=s);

  const list=document.getElementById('saves-list');
  list.innerHTML='';
  for(let i=1;i<=3;i++){
    const s=slotMap[i];
    const div=document.createElement('div');
    if(s){
      const d=new Date(s.updated_at);
      const timeStr=d.toLocaleDateString('zh-CN')+' '+d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
      div.className='sv';
      div.innerHTML=`
        <div class="sv-n">SLOT ${i}</div>
        <div class="sv-title">ARCANE HUNTER</div>
        <div class="sv-stat">
          â—ˆ é‡‘å¸ <span>${s.gold||0}</span><br>
          ğŸ“¦ ä»“åº“ <span>${(s.stash||[]).length} ä»¶</span><br>
          âš”ï¸ å‡ºå‡» <span>${s.raids||0} æ¬¡</span>
        </div>
        <div class="sv-time">${timeStr}</div>
        <div class="sv-del" onclick="deleteSave(event,${i})">âœ•</div>
      `;
      div.onclick=()=>loadSave(s);
    } else {
      div.className='sv empty';
      div.innerHTML=`<div class="sv-empty-icon">+</div><div class="sv-empty-txt">NEW GAME</div>`;
      div.onclick=()=>newGame(i);
    }
    list.appendChild(div);
  }
}

async function deleteSave(e,slot){
  e.stopPropagation();
  if(!confirm(`ç¡®è®¤åˆ é™¤å­˜æ¡£ ${slot}ï¼Ÿ`))return;
  await sb.from('saves').delete().eq('user_id',currentUser.id).eq('slot',slot);
  showSaves();
}

function newGame(slot){
  currentSlot=slot;
  gold=200;stash=[];loadout=[];
  equipSlots={weapon:null,armor:null,boots:null,acc:null};
  ammoSlots=[null,null,null,null];
  bagLoadout=[];
  document.getElementById('saves-screen').style.display='none';
  refreshMarket();
  renderHomebase();
  document.getElementById('homebase').style.display='flex';
  setSaveStatus('æ–°æ¡£ä½');
  autoSave();
}

function loadSave(s){
  currentSlot=s.slot;
  gold=s.gold||200;
  stash=(s.stash||[]).map(item=>({...item}));
  try{
    const ld=typeof s.loadout==='string'?JSON.parse(s.loadout):s.loadout||{};
    equipSlots=ld.equipSlots||{weapon:null,armor:null,boots:null,acc:null};
    ammoSlots=(ld.ammoSlots||[null,null,null,null]).map(a=>a||null);
    bagLoadout=(ld.bagLoadout||[]).map(i=>i||null);
  }catch(e){
    equipSlots={weapon:null,armor:null,boots:null,acc:null};
    ammoSlots=[null,null,null,null];
    bagLoadout=[];
  }
  loadout=[];
  document.getElementById('saves-screen').style.display='none';
  refreshMarket();
  renderHomebase();
  document.getElementById('homebase').style.display='flex';
  setSaveStatus('å·²è½½å…¥');
}

// â”€â”€ SAVE GAME â”€â”€
async function saveGame(){
  if(!currentUser||!currentSlot)return;
  setSaveStatus('ä¿å­˜ä¸­...');
  const payload={
    user_id:currentUser.id,
    slot:currentSlot,
    gold,
    stash:stash.map(i=>({...i})),
    loadout:JSON.stringify({
      equipSlots,
      ammoSlots,
      bagLoadout,
    }),
    raids:(await getRaids())+0,
    updated_at:new Date().toISOString(),
  };
  const {error}=await sb.from('saves').upsert(payload,{onConflict:'user_id,slot'});
  if(error){setSaveStatus('ä¿å­˜å¤±è´¥','err');}
  else{setSaveStatus('å·²ä¿å­˜ âœ“');}
}

async function getRaids(){
  const {data}=await sb.from('saves').select('raids').eq('user_id',currentUser.id).eq('slot',currentSlot).single();
  return data?.raids||0;
}

function setSaveStatus(msg){
  const el=document.getElementById('save-status');
  el.textContent=msg;
  clearTimeout(saveTimer);
  if(msg!=='ä¿å­˜ä¸­...')saveTimer=setTimeout(()=>{el.textContent='';},3000);
}

// Auto-save every 60s when on homebase
function autoSave(){
  setInterval(()=>{
    if(gameState==='homebase'&&currentUser&&currentSlot) saveGame();
  },60000);
}

// Save on extract
const _origGoHomebase=typeof goHomebase!=='undefined'?goHomebase:null;

// â”€â”€ INIT: check existing session â”€â”€
async function initAuth(){
  const {data}=await sb.auth.getSession();
  if(data.session){
    currentUser=data.session.user;
    document.getElementById('user-email').textContent=currentUser.email;
    document.getElementById('user-bar').style.display='flex';
    document.getElementById('login-screen').style.display='none';
    showSaves();
  }
  // else login screen stays visible (default)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W=900,H=600,MAP_W=2000,MAP_H=1600,TILE=40;

// â”€â”€ GAME BALANCE CONFIG â”€â”€ (edit these to tune the game)
const CONFIG={
  ENEMY_INITIAL: 14,   // enemies spawned at raid start
  ENEMY_MAX: 8,        // max enemies alive at once (respawn cap)
  ENEMY_RESPAWN: 2,    // enemies per respawn wave
  CHEST_COUNT: 20,     // number of chests on map
};
const COLS=Math.ceil(MAP_W/TILE),ROWS=Math.ceil(MAP_H/TILE);
const PICKUP_TIME=1.8; // seconds to loot
const PICKUP_RANGE=46;
const JOYSTICK_MAX=40;

// Elevation levels: 0=low, 1=mid, 2=high
// High can hit all, Mid can hit Mid+Low, Low can only hit Low
const ELEV_NAMES=['LOW GROUND','MID GROUND','HIGH GROUND'];
const ELEV_COLORS=['#4a3a2a','#4a4a2a','#2a4a5a'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAND DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WANDS=[
  {id:'ember',   name:'EMBER WAND',  icon:'ğŸ”¥',dmg:[12,18],range:160,spd:1.5,color:'#f97316',proj:'#fb923c',desc:'ç«ç„°Â·ä¸­è·',   size:[1,3],basePrice:120,aoe:0},
  {id:'frost',   name:'FROST STAFF', icon:'â„ï¸', dmg:[8,14], range:240,spd:0.9,color:'#67e8f9',proj:'#a5f3fc',desc:'å†°éœœÂ·è¿œè·Â·å‡é€Ÿ',size:[1,3],basePrice:150,slow:true,aoe:0},
  {id:'thunder', name:'THUNDER ROD', icon:'âš¡', dmg:[22,34],range:130,spd:0.55,color:'#fbbf24',proj:'#fde68a',desc:'é›·å‡»Â·é«˜ä¼¤',  size:[1,3],basePrice:200,aoe:0},
  {id:'void',    name:'VOID SCEPTER',icon:'ğŸŒ€',dmg:[15,22],range:190,spd:1.1,color:'#a855f7',proj:'#c084fc',desc:'è™šç©ºÂ·AOEç©¿é€',size:[1,3],basePrice:180,aoe:32,pierce:true},
  {id:'nature',  name:'NATURE WAND', icon:'ğŸŒ¿',dmg:[10,16],range:200,spd:1.3,color:'#4ade80',proj:'#86efac',desc:'è‡ªç„¶Â·å¸è¡€',  size:[1,3],basePrice:160,vamp:true,aoe:0},
  {id:'ancient', name:'ANCIENT TOME',icon:'ğŸ“œ',dmg:[28,44],range:260,spd:0.45,color:'#fcd34d',proj:'#fef08a',desc:'è¿œå¤Â·è¶…é«˜ä¼¤',size:[1,3],basePrice:300,aoe:0},
  {id:'poison',  name:'POISON ORB',  icon:'ğŸ’€',dmg:[6,10], range:170,spd:1.6,color:'#84cc16',proj:'#bef264',desc:'æ¯’Â·æŒç»­ä¼¤å®³', size:[1,2],basePrice:100,dot:true,aoe:0},
  {id:'blood',   name:'BLOOD LANCE', icon:'ğŸ©¸',dmg:[18,28],range:150,spd:0.8,color:'#dc2626',proj:'#f87171',desc:'è¡€çŸ›Â·é«˜ç©¿é€', size:[1,3],basePrice:220,pierce:true,aoe:0},
];


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARMOR DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ARMORS=[
  // Robes (defense) â€” 1Ã—2 grid
  {id:'robe1', name:'TATTERED ROBE',  icon:'ğŸ‘˜',type:'armor',tier:1,def:3, color:'#78716c',size:[1,2],basePrice:60, desc:'é˜²å¾¡+3'},
  {id:'robe2', name:'WOVEN MANTLE',   icon:'ğŸ¥»',type:'armor',tier:2,def:7, color:'#a16207',size:[1,2],basePrice:130,desc:'é˜²å¾¡+7'},
  {id:'robe3', name:'ARCANE VESTMENT',icon:'ğŸ©±',type:'armor',tier:3,def:13,color:'#6366f1',size:[1,2],basePrice:240,desc:'é˜²å¾¡+13'},
  {id:'robe4', name:'VOID SHROUD',    icon:'ğŸ¦º',type:'armor',tier:4,def:22,color:'#a855f7',size:[1,2],basePrice:400,desc:'é˜²å¾¡+22'},
  // Boots (move speed) â€” 1Ã—2 grid
  {id:'boot1', name:'WORN SANDALS',   icon:'ğŸ‘¡',type:'boots',tier:1,spd:0.3,color:'#78716c',size:[1,2],basePrice:50, desc:'é€Ÿåº¦+0.3'},
  {id:'boot2', name:'LEATHER BOOTS',  icon:'ğŸ‘¢',type:'boots',tier:2,spd:0.6,color:'#92400e',size:[1,2],basePrice:110,desc:'é€Ÿåº¦+0.6'},
  {id:'boot3', name:'SWIFT TREADS',   icon:'ğŸ¥¾',type:'boots',tier:3,spd:1.0,color:'#0891b2',size:[1,2],basePrice:200,desc:'é€Ÿåº¦+1.0'},
  {id:'boot4', name:'PHANTOM STEPS',  icon:'ğŸ‘Ÿ',type:'boots',tier:4,spd:1.6,color:'#7c3aed',size:[1,2],basePrice:350,desc:'é€Ÿåº¦+1.6'},
  // Accessories (bonus effects) â€” 1Ã—1 grid
  {id:'acc1',  name:'COPPER RING',    icon:'ğŸ’',type:'acc',  tier:1,maxHp:15,color:'#78716c',size:[1,1],basePrice:80, desc:'ç”Ÿå‘½+15'},
  {id:'acc2',  name:'SILVER AMULET',  icon:'ğŸ“¿',type:'acc',  tier:2,maxHp:30,color:'#94a3b8',size:[1,1],basePrice:160,desc:'ç”Ÿå‘½+30'},
  {id:'acc3',  name:'GOLD PENDANT',   icon:'ğŸ…',type:'acc',  tier:3,maxHp:50,xpBonus:0.2,color:'#f59e0b',size:[1,1],basePrice:280,desc:'ç”Ÿå‘½+50Â·ç»éªŒ+20%'},
  {id:'acc4',  name:'SOUL CRYSTAL',   icon:'ğŸ’',type:'acc',  tier:4,maxHp:80,xpBonus:0.4,color:'#22d3ee',size:[1,1],basePrice:500,desc:'ç”Ÿå‘½+80Â·ç»éªŒ+40%'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPIRIT CRYSTAL (çµæ™¶) DATA â€” ammo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4 elements Ã— 4 tiers = 16 types
// dmgMult: damage multiplier when loaded in matching wand
const ELEMENTS=['fire','ice','thunder','void'];
const ELEM_ICONS={'fire':'ğŸ”´','ice':'ğŸ”µ','thunder':'ğŸŸ¡','void':'ğŸŸ£'};
const ELEM_COLORS={'fire':'#f97316','ice':'#67e8f9','thunder':'#fbbf24','void':'#a855f7'};
// Wand â†’ element mapping
const WAND_ELEM={
  ember:'fire', frost:'ice', thunder:'thunder', void:'void',
  nature:'void', ancient:'fire', poison:'void', blood:'fire'
};
const CRYSTAL_TIERS=[
  {tier:1,name:'ç²—ç³™çµæ™¶',dmgMult:1.0,color:'#5a5a6a',basePrice:15},
  {tier:2,name:'ç²¾åˆ¶çµæ™¶',dmgMult:1.4,color:'#6366f1',basePrice:35},
  {tier:3,name:'çº¯åŒ–çµæ™¶',dmgMult:2.0,color:'#a855f7',basePrice:70},
  {tier:4,name:'è‡³çº¯çµæ™¶',dmgMult:3.5,color:'#fbbf24',basePrice:150},
];
const CRYSTALS=[];
ELEMENTS.forEach(elem=>{
  CRYSTAL_TIERS.forEach(t=>{
    CRYSTALS.push({
      id:`crystal_${elem}_${t.tier}`,
      name:`${t.name}Â·${elem==='fire'?'ç‚':elem==='ice'?'å†°':elem==='thunder'?'é›·':'è™šç©º'}`,
      icon:ELEM_ICONS[elem],
      type:'crystal',
      elem, tier:t.tier,
      dmgMult:t.dmgMult,
      color:ELEM_COLORS[elem],
      size:[1,1],
      stackMax:99,
      basePrice:t.basePrice,
      desc:`ä¼¤å®³Ã—${t.dmgMult}`,
    });
  });
});
function getCrystal(elem,tier){return CRYSTALS.find(c=>c.elem===elem&&c.tier===tier);}

const ALL_ITEMS=[...WANDS,...ARMORS,...CRYSTALS];

// Market prices fluctuate each visit
let marketPrices={};
function refreshMarket(){
  // Market: wands + armors + boots + acc + tier1-2 crystals only
  const marketItems=ALL_ITEMS.filter(w=>
    w.type!=='crystal' || w.tier<=2
  );
  marketItems.forEach(w=>{
    const base=w.basePrice;
    const factor=0.8+Math.random()*0.4;
    marketPrices[w.id]=Math.round(base*factor);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gold=200;
let stash=[];            // all items in homebase stash
// New loadout structure
let equipSlots={weapon:null,armor:null,boots:null,acc:null}; // equipped items
let ammoSlots=[null,null,null,null];   // crystal stacks {crystal,qty}
let bagLoadout=[];       // extra items carried in bag (max 4)
let selectedStorage=null;
let selectedEquipSlot=null;  // 'weapon'|'armor'|'boots'|'acc'
let selectedAmmoSlot=null;   // 0-3
let selectedLoadout=null;    // bag slot index
// Legacy compat
let loadout=[];

// In-raid
let gameState='homebase'; // homebase | playing | dead | extracted
let frames=0,lastTime=0;
let tileMap=[],elevMap=[];
let enemies=[],chests=[],droppedWands=[],projectiles=[],particles=[];
let player={};
let cam={x:0,y:0};
let pickupTarget=null,pickupProgress=0,pickupHolding=false;
let selectedInvIdx=null;
// Touch
const isTouchDevice=()=>navigator.maxTouchPoints>0;
let joystickDelta={x:0,y:0},joystickActive=false,joystickOrigin={x:0,y:0};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Smooth noise helpers â”€â”€
function smoothNoise(x,y,seed){
  // Simple smooth value noise with bilinear interpolation
  const ix=Math.floor(x),iy=Math.floor(y);
  const fx=x-ix,fy=y-iy;
  const u=fx*fx*(3-2*fx),v=fy*fy*(3-2*fy);
  function h(a,b){
    let n=((a*1619+b*31337+seed*6971)^(a*1619+b*31337+seed*6971)>>8)*0.00000023283;
    return Math.sin(n*127.1+n*311.7)*43758.5453%1;
  }
  return h(ix,iy)*(1-u)*(1-v)+h(ix+1,iy)*u*(1-v)+h(ix,iy+1)*(1-u)*v+h(ix+1,iy+1)*u*v;
}
function fbm(x,y,seed,oct=4){
  let v=0,amp=0.5,freq=1,max=0;
  for(let i=0;i<oct;i++){v+=smoothNoise(x*freq,y*freq,seed+i*100)*amp;max+=amp;amp*=0.5;freq*=2;}
  return v/max;
}

let heightMap=[];  // continuous 0..1 height per tile
let wallMask=[];   // 1=solid wall

function genMap(){
  const seed=Math.floor(Math.random()*9999);
  tileMap=[];elevMap=[];heightMap=[];wallMask=[];

  // Generate continuous height field
  for(let r=0;r<ROWS;r++){
    heightMap[r]=[];wallMask[r]=[];
    for(let c=0;c<COLS;c++){
      const hv=fbm(c/12,r/12,seed);
      heightMap[r][c]=hv;
      // Walls from separate high-freq noise
      const wn=fbm(c/4,r/4,seed+500,3);
      wallMask[r][c]=(wn>0.72&&r>1&&r<ROWS-2&&c>1&&c<COLS-2)?1:0;
    }
  }

  // Derive tileMap and elevMap from height
  for(let r=0;r<ROWS;r++){
    tileMap[r]=[];elevMap[r]=[];
    for(let c=0;c<COLS;c++){
      if(r===0||r===ROWS-1||c===0||c===COLS-1){tileMap[r][c]=1;elevMap[r][c]=0;continue;}
      tileMap[r][c]=wallMask[r][c];
      const h=heightMap[r][c];
      elevMap[r][c]=tileMap[r][c]?0:h>0.72?2:h>0.52?1:0;
    }
  }
  // Clear spawn area
  for(let r=1;r<9;r++)for(let c=1;c<14;c++){tileMap[r][c]=0;elevMap[r][c]=0;heightMap[r][c]=0.3;}
  // Clear extract area
  for(let r=ROWS-9;r<ROWS-1;r++)for(let c=COLS-9;c<COLS-1;c++){tileMap[r][c]=0;elevMap[r][c]=0;heightMap[r][c]=0.3;}

  // Generate scatter props (rocks, pillars, runes, bones)
  genScatter();
}

let scatterProps=[];
const PROP_TYPES=[
  {type:'rock',   icons:['â¬Ÿ','â¬¡'],colors:['#3a3a4a','#2e2e3e','#44445a'],r:8},
  {type:'pillar', icons:['â–®','â–¯'],colors:['#4a3a2a','#3a2e1e','#5a4a30'],r:6},
  {type:'rune',   icons:['âœ¦','âœ§','â‹'],colors:['#6366f188','#a855f788','#4ade8044'],r:5,glow:true},
  {type:'bones',  icons:['âœ•','Ã—'],colors:['#4a4040','#3a3030'],r:4},
  {type:'torch',  icons:['ğ„¬'],colors:['#f97316'],r:4,glow:true,light:true},
];
function genScatter(){
  scatterProps=[];
  const count=180;
  for(let i=0;i<count;i++){
    const wx=60+Math.random()*(MAP_W-120);
    const wy=60+Math.random()*(MAP_H-120);
    if(isSolid(wx,wy))continue;
    if(dist(wx,wy,160,160)<120)continue; // not in spawn
    const pt=PROP_TYPES[Math.floor(Math.random()*PROP_TYPES.length)];
    const icon=pt.icons[Math.floor(Math.random()*pt.icons.length)];
    const color=pt.colors[Math.floor(Math.random()*pt.colors.length)];
    const elv=getElev(wx,wy);
    scatterProps.push({wx,wy,type:pt.type,icon,color,r:pt.r,glow:!!pt.glow,light:!!pt.light,elv,
      phase:Math.random()*Math.PI*2, scale:0.7+Math.random()*0.6});
  }
}

function isSolid(wx,wy){
  const c=Math.floor(wx/TILE),r=Math.floor(wy/TILE);
  if(r<0||r>=ROWS||c<0||c>=COLS)return true;
  return tileMap[r][c]===1;
}
function getElev(wx,wy){
  const c=Math.floor(wx/TILE),r=Math.floor(wy/TILE);
  if(r<0||r>=ROWS||c<0||c>=COLS)return 0;
  return elevMap[r][c]||0;
}
// Get smooth continuous height 0..1 for rendering
function getSmoothHeight(wx,wy){
  const c=wx/TILE,r=wy/TILE;
  const ic=Math.floor(c),ir=Math.floor(r);
  const fc=c-ic,fr=r-ir;
  function gh(rr,cc){
    if(rr<0||rr>=ROWS||cc<0||cc>=COLS)return 0;
    return heightMap[rr]?heightMap[rr][cc]||0:0;
  }
  const h00=gh(ir,ic),h10=gh(ir,ic+1),h01=gh(ir+1,ic),h11=gh(ir+1,ic+1);
  return h00*(1-fc)*(1-fr)+h10*fc*(1-fr)+h01*(1-fc)*fr+h11*fc*fr;
}
function canAttack(attackerElev,targetElev){
  // High hits all, mid hits mid+low, low hits only low
  return attackerElev>=targetElev;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ENEMY_TYPES=[
  {name:'SHADE',  hp:65,  spd:1.3,dmg:9,  color:'#6366f1',r:12,xp:20,elev:0},
  {name:'WRAITH', hp:130, spd:0.9,dmg:15, color:'#a855f7',r:16,xp:40,elev:1},
  {name:'GOLEM',  hp:320, spd:0.45,dmg:28,color:'#78716c',r:22,xp:100,elev:0},
  {name:'SPECTER',hp:50,  spd:2.3,dmg:6,  color:'#22d3ee',r:9, xp:15,elev:0},
  {name:'CULTIST',hp:95,  spd:1.0,dmg:19, color:'#dc2626',r:14,xp:35,elev:1},
  {name:'ARCHER', hp:70,  spd:0.8,dmg:14, color:'#f59e0b',r:11,xp:30,elev:2,ranged:true,range:200},
];


// Roll enemy loot table at spawn time
// Each enemy drops: 1 random crystal stack + 20% chance weapon/armor
function rollEnemyDrops(){
  const drops=[];
  // Always drop 2-3 crystal stacks
  const numCrystalDrops=2+Math.floor(Math.random()*2);
  for(let i=0;i<numCrystalDrops;i++){
    const elem=ELEMENTS[Math.floor(Math.random()*ELEMENTS.length)];
    // Higher tier crystals rarer: 60% t1, 25% t2, 12% t3, 3% t4
    const r=Math.random();
    const tier=r<0.6?1:r<0.85?2:r<0.97?3:4;
    const crystal=getCrystal(elem,tier);
    if(crystal){
      const qty=3+Math.floor(Math.random()*8);
      drops.push(Object.assign({},crystal,{qty}));
    }
  }
  // 25% chance: drop a weapon
  if(Math.random()<0.25){
    const w=WANDS[Math.floor(Math.random()*WANDS.length)];
    drops.push(Object.assign({},w));
  }
  // 20% chance: drop armor/boots/acc
  if(Math.random()<0.20){
    const pool=[...ARMORS];
    const a=pool[Math.floor(Math.random()*pool.length)];
    drops.push(Object.assign({},a));
  }
  return drops;
}

function spawnEnemies(){
  enemies=[];
  for(let i=0;i<CONFIG.ENEMY_INITIAL;i++){
    let wx,wy,tries=0;
    do{wx=200+Math.random()*(MAP_W-400);wy=200+Math.random()*(MAP_H-400);tries++;}
    while((isSolid(wx,wy)||dist(wx,wy,160,160)<220)&&tries<60);
    const t=ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
    const spawnElev=t.elev||getElev(wx,wy);
    // Pre-roll enemy drops at spawn
    const drops=rollEnemyDrops();
    enemies.push({wx,wy,hp:t.hp,maxHp:t.hp,spd:t.spd,dmg:t.dmg,color:t.color,r:t.r,xp:t.xp,name:t.name,
      elev:spawnElev,attackCd:0,attackRate:1.1,aggroRange:200,wanderAngle:Math.random()*Math.PI*2,
      drops,slowTimer:0,dotTimer:0,ranged:t.ranged||false,range:t.range||60,
      phase:Math.random()*Math.PI*2});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnChests(){
  chests=[];
  for(let i=0;i<CONFIG.CHEST_COUNT;i++){
    let wx,wy,tries=0;
    do{wx=80+Math.random()*(MAP_W-160);wy=80+Math.random()*(MAP_H-160);tries++;}
    while(isSolid(wx,wy)&&tries<50);
    // Chests: 40% armor, 30% crystals, 30% wands
    const rr=Math.random();
    const pool=rr<0.3?ARMORS:rr<0.6?CRYSTALS:WANDS;
    const wand=pool[Math.floor(Math.random()*pool.length)];
    const chestItem=Object.assign({},wand);
    if(chestItem.type==='crystal') chestItem.qty=5+Math.floor(Math.random()*15);
    chests.push({wx,wy,wand:chestItem,opened:false,gp:Math.random()*Math.PI*2});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INV_COLS=6,INV_ROWS=4;

function initPlayer(){
  player={
    wx:160,wy:160,
    hp:100,maxHp:100,
    baseSpd:2.9,spd:2.9,r:12,
    baseDef:0,def:0,
    inventory:[],
    equippedIdx:null,
    armorSlot:null,   // equipped armor item ref
    bootsSlot:null,   // equipped boots item ref
    accSlot:null,     // equipped accessory item ref
    xp:0,xpNext:100,level:1,
    attackCd:0,
    elev:0,prevElev:0,
    // Elevation jump animation
    elevAnimT:0,      // 0..1 animation progress
    elevAnimDir:0,    // +1 up, -1 down
    visualElevOffset:0, // current visual Y offset (animated)
  };
  // Load weapon into inventory and auto-equip
  if(equipSlots.weapon){
    placeItemInGrid(equipSlots.weapon);
    player.equippedIdx=0; // weapon is always placed first
  }
  // Load bag items
  bagLoadout.forEach(it=>{ if(it) placeItemInGrid(it); });
  // Load ammo into player ammo pool
  player.ammoPool=[];
  ammoSlots.forEach(a=>{ if(a&&a.crystal) player.ammoPool.push({crystal:Object.assign({},a.crystal),qty:a.qty}); });
  // Set armor bonuses from equipped slots (applied directly, not in inventory)
  player.equippedArmor=equipSlots.armor?Object.assign({},equipSlots.armor):null;
  player.equippedBoots=equipSlots.boots?Object.assign({},equipSlots.boots):null;
  player.equippedAcc=equipSlots.acc?Object.assign({},equipSlots.acc):null;
  recalcStats();
  updateInvGrid();
}

function recalcStats(){
  player.def=0;
  const baseSpd=player.baseSpd||2.9;
  let spdBonus=0,hpBonus=0;
  // From equipped armor slots
  if(player.equippedArmor) player.def+=(player.equippedArmor.def||0);
  if(player.equippedBoots) spdBonus+=(player.equippedBoots.spd||0);
  if(player.equippedAcc){
    hpBonus+=(player.equippedAcc.maxHp||0);
  }
  player.spd=Math.min(baseSpd+spdBonus,6);
  const newMaxHp=100+hpBonus+(player.level-1)*20;
  if(newMaxHp>player.maxHp) player.hp+=newMaxHp-player.maxHp;
  player.maxHp=newMaxHp;
  player.hp=Math.min(player.hp,player.maxHp);
}

function placeItemInGrid(itemData){
  const it={...itemData};
  const [sw,sh]=it.size;
  for(let gy=0;gy<=INV_ROWS-sh;gy++){
    for(let gx=0;gx<=INV_COLS-sw;gx++){
      if(canPlace(gx,gy,sw,sh)){
        const entry={item:it,gx,gy,equipped:false};
        player.inventory.push(entry);
        // Auto-equip first wand
        if(player.equippedIdx===null && !it.type) player.equippedIdx=player.inventory.length-1;
        return true;
      }
    }
  }
  return false;
}
// Keep old name as alias for wands
function placeWandInGrid(wand){ return placeItemInGrid(wand); }

function canPlace(gx,gy,sw,sh,excludeIdx=null){
  for(let i=0;i<player.inventory.length;i++){
    if(i===excludeIdx)continue;
    const entry=player.inventory[i];
    const it=entry.item||entry.wand;
    if(!it)continue;
    const [isw,ish]=it.size;
    if(gx<entry.gx+isw&&gx+sw>entry.gx&&gy<entry.gy+ish&&gy+sh>entry.gy)return false;
  }
  return true;
}

function getEquipped(){
  if(player.equippedIdx===null||player.equippedIdx>=player.inventory.length)return null;
  const entry=player.inventory[player.equippedIdx];
  if(!entry)return null;
  // Return wand-like object (item may be wand or have .item)
  return entry.item||entry.wand||null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTORY GRID UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CELL=30,GAP=2;
function updateInvGrid(){
  const grid=document.getElementById('inv-grid');
  grid.innerHTML='';
  for(let r=0;r<INV_ROWS;r++)for(let c=0;c<INV_COLS;c++){
    const cell=document.createElement('div');cell.className='inv-cell';grid.appendChild(cell);
  }
  player.inventory.forEach((entry,idx)=>{
    const it=entry.item||entry.wand;
    if(!it)return;
    const [sw,sh]=it.size;
    const isWand=!it.type;
    const isEquippedWand=isWand&&player.equippedIdx===idx;
    const isEquippedArmor=entry.equipped;
    const isEq=isEquippedWand||isEquippedArmor;
    const isSel=selectedInvIdx===idx;
    const block=document.createElement('div');
    block.className='inv-item-block'+(isSel?' selected':'')+(isEq?' is-equipped':'');
    block.style.cssText=
      `left:${entry.gx*(CELL+GAP)}px;`+
      `top:${entry.gy*(CELL+GAP)}px;`+
      `width:${sw*CELL+(sw-1)*GAP}px;`+
      `height:${sh*CELL+(sh-1)*GAP}px;`+
      `background:${it.color}28;`+
      `border-color:${isEq?'#4ade80':it.color+'99'};`+
      `color:${it.color};`;
    // Type badge color
    const typeColor=it.type==='armor'?'#94a3b8':it.type==='boots'?'#4ade80':it.type==='acc'?'#fbbf24':'#c084fc';
    block.innerHTML=
      `<span style="font-size:16px;line-height:1">${it.icon}</span>`+
      `<span class="inv-item-name" style="color:${typeColor}">${it.name.split(' ')[0]}</span>`+
      (isEq?`<span style="font-size:5px;color:#4ade80;line-height:1">â–¶EQ</span>`:'');
    block.title=`${it.name}\n${it.desc||''}`;
    block.onclick=()=>{
      selectedInvIdx=(selectedInvIdx===idx)?null:idx;
      updateInvGrid();
      document.getElementById('btn-equip').disabled=selectedInvIdx===null;
      document.getElementById('btn-drop').disabled=selectedInvIdx===null;
      // handled below
    };
    grid.appendChild(block);
  });
  document.getElementById('inv-weight').textContent=`${player.inventory.length} / 8 slots`;

  const w=getEquipped();
  document.getElementById('weapon-name').textContent=w?w.name:'BARE HANDS';
  // Stats line: weapon + armor bonuses
  const defStr=player.def>0?` Â· DEF ${player.def}`:'';
  const spdStr=player.spd>3?` Â· SPD ${player.spd.toFixed(1)}`:'';
  document.getElementById('weapon-stats').textContent=
    w?`DMG ${w.dmg[0]}â€“${w.dmg[1]} Â· RNG ${w.range}${defStr}${spdStr}`:`æ— æ­¦å™¨${defStr}${spdStr}`;
  document.getElementById('hp-fill').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('xp-fill').style.width=(player.xp/player.xpNext*100)+'%';
}

function equipSelected(){
  if(selectedInvIdx===null)return;
  const entry=player.inventory[selectedInvIdx];
  const it=entry.item||entry.wand;
  if(!it)return;
  if(!it.type){
    // It's a wand
    player.equippedIdx=selectedInvIdx;
    addLog(`è£…å¤‡æ³•æ–: ${it.name}`,'info');
  } else {
    // Armor/boots/acc â€” toggle equipped on this entry
    // Unequip same type first
    player.inventory.forEach((e,i)=>{
      if(i!==selectedInvIdx&&e.item&&e.item.type===it.type) e.equipped=false;
    });
    entry.equipped=!entry.equipped;
    addLog((entry.equipped?'è£…å¤‡':'å¸ä¸‹')+`: ${it.name}`,'info');
    recalcStats();
  }
  updateInvGrid();
}


function sellFromInventory(){
  if(selectedInvIdx===null)return;
  const entry=player.inventory[selectedInvIdx];
  if(!entry)return;
  const it=entry.item||entry.wand;
  if(!it)return;
  // Use market price or base price
  const price=marketPrices[it.id]||it.basePrice||20;
  // If crystal, sell stack
  const qty=it.qty||1;
  const total=it.type==='crystal'?Math.floor(price*qty):price;
  gold+=total;
  player.inventory.splice(selectedInvIdx,1);
  selectedInvIdx=null;
  updateInvGrid();
  document.getElementById('btn-equip').disabled=true;
  document.getElementById('btn-drop').disabled=true;
  document.getElementById('btn-sell-inv').disabled=true;
  document.getElementById('gold-display').textContent='â—ˆ '+gold;
  addLog(`å”®å‡º ${it.name} +â—ˆ${total}`,'loot');
}


function sellFromBackpack(){
  if(selectedInvIdx===null)return;
  const entry=player.inventory[selectedInvIdx];
  if(!entry)return;
  const it=entry.item||entry.wand;
  const price=marketPrices[it.id]||it.basePrice||0;
  const sellPrice=Math.floor(price*0.8);
  gold+=sellPrice;
  player.inventory.splice(selectedInvIdx,1);
  selectedInvIdx=null;
  updateInvGrid();
  document.getElementById('gold-display').textContent=`â—ˆ ${gold}`;
  addLog(`å–å‡º ${it.name} +â—ˆ${sellPrice}`,'loot');
}
function dropSelected(){
  if(selectedInvIdx===null)return;
  const entry=player.inventory.splice(selectedInvIdx,1)[0];
  const it=entry.item||entry.wand;
  droppedWands.push({
    wx:player.wx+Math.cos(Math.random()*Math.PI*2)*20,
    wy:player.wy+Math.sin(Math.random()*Math.PI*2)*20,
    wand:it  // keep field name for compat
  });
  if(player.equippedIdx>=player.inventory.length)player.equippedIdx=player.inventory.length>0?0:null;
  selectedInvIdx=null;
  document.getElementById('btn-equip').disabled=true;
  document.getElementById('btn-drop').disabled=true;
  recalcStats();
  addLog(`ä¸¢å¼ƒ: ${it.name}`,'info');
  updateInvGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKUP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePickup(dt){
  if(!pickupTarget){
    pickupProgress=0;
    document.getElementById('pickup-bar-wrap').style.display='none';
    return;
  }
  const d=dist(player.wx,player.wy,pickupTarget.wx,pickupTarget.wy);
  if(d>PICKUP_RANGE){
    // Left range, reset
    pickupProgress=0;
    pickupTarget=null;
    document.getElementById('pickup-bar-wrap').style.display='none';
    addLog('æ‹¾å–ä¸­æ–­','info');
    return;
  }
  pickupProgress+=dt/PICKUP_TIME;
  document.getElementById('pickup-bar-wrap').style.display='flex';
  document.getElementById('pickup-fill').style.width=(pickupProgress*100)+'%';
  document.getElementById('pickup-label').textContent='LOOTING: '+pickupTarget.wand.name;

  if(pickupProgress>=1){
    finishPickup();
  }
}

function finishPickup(){
  if(!pickupTarget)return;
  const wand=pickupTarget.wand;
  const placed=placeItemInGrid(wand);
  if(!placed){
    addLog('èƒŒåŒ…å·²æ»¡!','dmg');
    pickupTarget=null;pickupProgress=0;
    document.getElementById('pickup-bar-wrap').style.display='none';
    return;
  }
  // Remove from world
  const ci=chests.findIndex(c=>c===pickupTarget);
  if(ci>=0){chests[ci].opened=true;}
  else{const di=droppedWands.findIndex(d=>d===pickupTarget);if(di>=0)droppedWands.splice(di,1);}
  addLog(`æ‹¾å–: ${wand.name}`,'loot');
  spawnParticles(pickupTarget.wx,pickupTarget.wy,wand.color,12,3);
  pickupTarget=null;pickupProgress=0;
  document.getElementById('pickup-bar-wrap').style.display='none';
  recalcStats();
  updateInvGrid();
}

function tryStartPickup(){
  // Find nearest lootable
  let best=null,bestD=PICKUP_RANGE;
  for(const ch of chests){
    if(ch.opened)continue;
    const d=dist(player.wx,player.wy,ch.wx,ch.wy);
    if(d<bestD){bestD=d;best=ch;}
  }
  for(const dw of droppedWands){
    const d=dist(player.wx,player.wy,dw.wx,dw.wy);
    if(d<bestD){bestD=d;best=dw;}
  }
  if(best){
    if(pickupTarget===best)return; // already looting this
    pickupTarget=best;
    pickupProgress=0;
    addLog(`å¼€å§‹æ‹¾å– ${best.wand.name}...`,'info');
  }
}

function startPickupTouch(e){e.preventDefault();tryStartPickup();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(wx,wy,color,count=8,speed=2){
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*speed+.5;
    particles.push({wx,wy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,maxLife:1,color,r:Math.random()*4+1});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playerShoot(dt){
  const w=getEquipped();
  const rate=w?w.spd:1.2;
  player.attackCd-=dt;
  if(player.attackCd>0)return;
  const range=w?w.range:40;
  const pElev=getElev(player.wx,player.wy);

  let closest=null,closestD=Infinity;
  for(const e of enemies){
    if(!canAttack(pElev,e.elev))continue; // can't hit higher ground
    const d=dist(player.wx,player.wy,e.wx,e.wy);
    if(d<range&&d<closestD){closestD=d;closest=e;}
  }
  if(!closest)return;

  player.attackCd=1/rate;
  const [nx,ny]=normalize(closest.wx-player.wx,closest.wy-player.wy);
  projectiles.push({
    wx:player.wx,wy:player.wy,
    vx:nx*5,vy:ny*5,
    dmg:(w?w.dmg[0]:5)+Math.random()*((w?w.dmg[1]:8)-(w?w.dmg[0]:5)),
    color:w?w.proj:'#e2e8f0',
    life:1.6,r:w&&w.aoe>0?8:5,
    aoe:w?w.aoe:0,pierce:w?!!w.pierce:false,
    slow:w?!!w.slow:false,vamp:w?!!w.vamp:false,
    dot:w?!!w.dot:false,
    fromElev:pElev,
    hit:new Set(),
  });
}

function updateEnemies(dt){
  for(const e of enemies){
    e.phase+=dt;
    const d=dist(player.wx,player.wy,e.wx,e.wy);
    const pElev=getElev(player.wx,player.wy);

    if(d<e.aggroRange){
      const [nx,ny]=normalize(player.wx-e.wx,player.wy-e.wy);
      const spd=(e.slowTimer>0)?e.spd*.4:e.spd;
      const nx2=e.wx+nx*spd,ny2=e.wy+ny*spd;
      if(!isSolid(nx2,e.wy))e.wx=nx2;
      if(!isSolid(e.wx,ny2))e.wy=ny2;
      // Update elevation to terrain
      e.elev=getElev(e.wx,e.wy);
    }else{
      e.wanderAngle+=(Math.random()-.5)*.2;
      const nx2=e.wx+Math.cos(e.wanderAngle)*.6,ny2=e.wy+Math.sin(e.wanderAngle)*.6;
      if(!isSolid(nx2,e.wy))e.wx=nx2;else e.wanderAngle+=Math.PI/2;
      if(!isSolid(e.wx,ny2))e.wy=ny2;
      e.elev=getElev(e.wx,e.wy);
    }

    if(e.slowTimer>0)e.slowTimer-=dt;
    if(e.dotTimer>0){e.dotTimer-=dt;e.hp-=dt*4;}

    // Attack player (only if can attack elevation)
    if(canAttack(e.elev,pElev)&&d<e.r+player.r+8){
      e.attackCd-=dt;
      if(e.attackCd<=0){
        e.attackCd=1/e.attackRate;
        const rawDmg=e.dmg+Math.random()*4-2;
        const dmg=Math.max(1,rawDmg-player.def*0.4);
        player.hp=Math.max(0,player.hp-dmg);
        addLog(`${e.name} é€ æˆ ${Math.round(dmg)} ä¼¤å®³`+(player.def>0?` (å‡å…${Math.round(rawDmg-dmg)})`:''),'dmg');
        updateInvGrid();
        if(player.hp<=0)killPlayer();
      }
    }else{e.attackCd=Math.max(0,e.attackCd-dt);}
  }
}

function updateProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    p.wx+=p.vx;p.wy+=p.vy;
    p.life-=dt;
    if(p.life<=0||isSolid(p.wx,p.wy)){projectiles.splice(i,1);continue;}

    for(const e of enemies){
      if(p.hit.has(e))continue;
      if(!canAttack(p.fromElev,e.elev))continue; // elevation blocks
      if(dist(p.wx,p.wy,e.wx,e.wy)<e.r+p.r){
        p.hit.add(e);
        e.hp-=p.dmg;
        if(p.slow)e.slowTimer=2.5;
        if(p.dot)e.dotTimer=3;
        if(p.vamp)player.hp=Math.min(player.maxHp,player.hp+p.dmg*.3);
        spawnParticles(e.wx,e.wy,p.color,5,2);
        if(p.aoe>0)enemies.forEach(e2=>{if(dist(p.wx,p.wy,e2.wx,e2.wy)<p.aoe+e2.r){e2.hp-=p.dmg*.5;spawnParticles(e2.wx,e2.wy,p.color,3,1.5);}});

        // Kill check
        enemies.filter(e2=>e2.hp<=0).forEach(e2=>{
          player.xp+=e2.xp;
          addLog(`å‡»æ€ ${e2.name} +${e2.xp}xp`,'imp');
          spawnParticles(e2.wx,e2.wy,e2.color,20,4);
          // Drop all pre-rolled items
          if(e2.drops&&e2.drops.length>0){
            const angle=Math.random()*Math.PI*2;
            e2.drops.forEach((item,di)=>{
              const a=angle+di*0.8;
              const spread=12+di*8;
              droppedWands.push({
                wx:e2.wx+Math.cos(a)*spread,
                wy:e2.wy+Math.sin(a)*spread,
                wand:Object.assign({},item)
              });
              const label=item.type==='crystal'?`${item.name}Ã—${item.qty||1}`:item.name;
              addLog(`æ‰è½: ${label}`,'loot');
            });
          }
          enemies.splice(enemies.indexOf(e2),1);
          checkLevelUp();
        });

        if(!p.pierce){projectiles.splice(i,1);break;}
      }
    }
  }
}

function checkLevelUp(){
  while(player.xp>=player.xpNext){
    player.xp-=player.xpNext;player.level++;player.xpNext=Math.floor(player.xpNext*1.4);
    player.maxHp+=20;player.hp=Math.min(player.maxHp,player.hp+30);
    addLog(`LEVEL UP LV${player.level}! ç”Ÿå‘½+20`,'imp');
  }
  updateInvGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEATH / EXTRACT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function killPlayer(){
  if(gameState!=='playing')return;
  gameState='dead';
  player.inventory.forEach((item,i)=>{
    const a=(i/player.inventory.length)*Math.PI*2;
    droppedWands.push({wx:player.wx+Math.cos(a)*35,wy:player.wy+Math.sin(a)*35,wand:item.wand});
  });
  spawnParticles(player.wx,player.wy,'#e53e3e',30,6);
  const ds=document.getElementById('death-screen');
  ds.style.display='flex';
  document.getElementById('death-msg').textContent=`LV${player.level} é˜µäº¡ â€” èƒŒåŒ…ç‰©å“å·²æ‰è½ Â· å®¶å›­ä»“åº“å®‰å…¨`;
}

const extractPoint={wx:MAP_W-150,wy:MAP_H-150};

function checkExtract(){
  if(dist(player.wx,player.wy,extractPoint.wx,extractPoint.wy)<50){
    gameState='extracted';
    // Move inventory to stash
    // Return inventory items to stash
    const gained=player.inventory.map(i=>i.item||i.wand);
    gained.forEach(w=>addToStash({...w}));
    // Return unused ammo to stash
    if(player.ammoPool){
      player.ammoPool.filter(a=>a.qty>0).forEach(a=>{
        addToStash(Object.assign({},a.crystal,{qty:a.qty}));
      });
    }
    const es=document.getElementById('extract-screen');
    es.style.display='flex';
    document.getElementById('extract-summary').innerHTML=
      `æ’¤ç¦»æˆåŠŸï¼<br><br>`+
      (gained.length>0?gained.map(w=>`${w.icon} ${w.name}`).join('<br>'): 'ç©ºæ‰‹æ’¤ç¦»')+
      `<br><br>å·²å­˜å…¥ä»“åº“`;
  }
}

function goHomebase(){
  gameState='homebase';
  document.getElementById('death-screen').style.display='none';
  document.getElementById('extract-screen').style.display='none';
  document.getElementById('hud').style.display='none';
  document.getElementById('homebase').style.display='flex';
  document.getElementById('touch-btns').style.display='none';
  document.getElementById('joystick-base').style.display='none';
  refreshMarket();
  renderHomebase();
  // Auto-save on return to base
  if(currentUser&&currentSlot) saveGame();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOMEBASE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHomebase(){
  document.getElementById('hb-gold-val').textContent=gold;

  // â”€â”€ STASH â”€â”€
  const sg=document.getElementById('storage-grid');
  sg.innerHTML='';
  const stashSlots=20;
  for(let i=0;i<stashSlots;i++){
    const slot=document.createElement('div');
    const it=stash[i];
    const isSel=selectedStorage===i;
    slot.className='storage-slot'+(it?' occupied':'')+(isSel?' selected-storage':'');
    if(it){
      const isStack=it.type==='crystal';
      slot.innerHTML=`<div style="font-size:${isStack?16:18}px">${it.icon}</div>`+
        (isStack?`<div style="font-size:8px;font-weight:bold;color:${it.color}">${it.qty||1}</div>`:'') +
        `<div class="slot-name">${it.name.split('Â·')[0]}</div>`;
      if(isSel)slot.style.borderColor='#fbbf24';
    }
    slot.onclick=()=>{
      if(!it){selectedStorage=null;selectedEquipSlot=null;selectedAmmoSlot=null;selectedLoadout=null;}
      else{selectedStorage=(isSel?null:i);}
      updateLoadoutHint();
      renderHomebase();
    };
    sg.appendChild(slot);
  }

  // â”€â”€ EQUIPMENT SLOTS â”€â”€
  ['weapon','armor','boots','acc'].forEach(type=>{
    const slotEl=document.getElementById(`eslot-${type}`);
    const it=equipSlots[type];
    const isSel=selectedEquipSlot===type;
    if(it){
      slotEl.className='equip-slot filled'+(isSel?' selected':'');
      slotEl.style.borderColor=it.color+'88';
      slotEl.innerHTML=
        `<span class="eslot-icon">${it.icon}</span>`+
        `<span class="eslot-name">${it.name.split(' ')[0]}</span>`+
        `<span class="eslot-del" onclick="unequipSlot('${type}',event)">âœ•</span>`;
    } else {
      slotEl.className='equip-slot'+(isSel?' selected':'');
      const empIcon={'weapon':'âš”','armor':'ğŸ›¡','boots':'ğŸ‘¢','acc':'ğŸ’'}[type];
      slotEl.innerHTML=`<span class="eslot-empty">${empIcon}</span>`;
    }
  });

  // â”€â”€ AMMO SLOTS â”€â”€
  for(let i=0;i<4;i++){
    const slotEl=document.getElementById(`aslot-${i}`);
    const a=ammoSlots[i];
    const isSel=selectedAmmoSlot===i;
    if(a&&a.crystal){
      slotEl.className='ammo-slot filled'+(isSel?' selected':'');
      slotEl.style.borderColor=a.crystal.color+'88';
      slotEl.innerHTML=
        `<span class="aslot-icon">${a.crystal.icon}</span>`+
        `<span class="aslot-count" style="color:${a.crystal.color}">${a.qty}</span>`+
        `<span class="aslot-name">${a.crystal.name.split('Â·')[0]} T${a.crystal.tier}</span>`+
        `<span class="aslot-del" onclick="clearAmmoSlot(${i},event)">âœ•</span>`;
    } else {
      slotEl.className='ammo-slot'+(isSel?' selected':'');
      slotEl.innerHTML=`<span class="aslot-empty">+</span>`;
    }
  }

  // â”€â”€ BAG LOADOUT â”€â”€
  const lg=document.getElementById('loadout-grid');
  lg.innerHTML='';
  for(let i=0;i<4;i++){
    const slot=document.createElement('div');
    const it=bagLoadout[i];
    const isSel=selectedLoadout===i;
    slot.className='loadout-slot'+(it?' occupied':'')+(isSel?' selected-loadout':'');
    if(it){
      const isStack=it.type==='crystal';
      slot.innerHTML=`<div style="font-size:16px">${it.icon}</div>`+
        (isStack?`<div style="font-size:7px;color:${it.color}">${it.qty||1}å‘</div>`:'') +
        `<div class="slot-name">${it.name.split(' ')[0]}</div>`;
      slot.style.borderColor=it.color+'66';
    } else if(selectedStorage!==null&&stash[selectedStorage]){
      slot.style.borderColor='#fbbf2444';
      slot.innerHTML=`<div style="font-size:11px;color:#fbbf2444">+</div>`;
    }
    slot.onclick=()=>{
      if(selectedStorage!==null&&stash[selectedStorage]&&!it){
        // Place stash item into bag slot
        bagLoadout[i]=Object.assign({},stash[selectedStorage]);
        stash.splice(selectedStorage,1);
        selectedStorage=null;
        updateLoadoutHint();
        renderHomebase();
      } else if(it){
        // Return to stash
        addToStash(it);
        bagLoadout[i]=null;
        renderHomebase();
      }
    };
    lg.appendChild(slot);
  }

  // â”€â”€ MARKET â”€â”€
  const ml=document.getElementById('market-list');
  ml.innerHTML='';
  // Market: wands + armors + boots + acc + tier1-2 crystals only
  const marketItems=ALL_ITEMS.filter(w=>
    w.type!=='crystal' || w.tier<=2
  );
  marketItems.forEach(w=>{
    const price=marketPrices[w.id]||w.basePrice;
    const trend=price>w.basePrice?'up':'down';
    const trendIcon=trend==='up'?'â–²':'â–¼';
    const inStash=stash.some(s=>s.id===w.id);
    const typeLabel=w.type==='armor'?'[é˜²]':w.type==='boots'?'[é‹]':w.type==='acc'?'[é¥°]':w.type==='crystal'?'[æ™¶]':'[æ–]';
    const typeClr=w.type==='crystal'?w.color:w.type==='armor'?'#94a3b8':w.type==='boots'?'#4ade80':w.type==='acc'?'#fbbf24':'#c084fc';
    const div=document.createElement('div');
    div.className='market-item';
    div.innerHTML=`
      <div class="mi-icon">${w.icon}</div>
      <div class="mi-info">
        <div class="mi-name">${w.name} <span style="font-size:6px;color:${typeClr}">${typeLabel}</span></div>
        <div class="mi-price">
          <span class="price-val">â—ˆ${price}</span>
          <span class="price-trend ${trend}">${trendIcon}</span>
          Â· ${w.desc||''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <button class="mi-action mi-sell" ${inStash?'':'disabled'}
          onclick="sellItem('${w.id}',${price})">å–å‡º</button>
        <button class="mi-action mi-buy" ${gold>=price?'':'disabled'}
          onclick="buyItem('${w.id}',${price})">â—ˆ${price}</button>
      </div>
    `;
    ml.appendChild(div);
  });
}


function updateInRaidEquipDisplay(){
  const slots={
    weapon:{id:'ieq-weapon',fallback:'âš”',label:'æ­¦å™¨'},
    armor:{id:'ieq-armor',fallback:'ğŸ›¡',label:'é˜²'},
    boots:{id:'ieq-boots',fallback:'ğŸ‘¢',label:'é‹'},
    acc:{id:'ieq-acc',fallback:'ğŸ’',label:'é¥°'},
  };
  Object.entries(slots).forEach(([type,cfg])=>{
    const el=document.getElementById(cfg.id);
    if(!el)return;
    const item=type==='weapon'?getEquipped():player['equipped'+type.charAt(0).toUpperCase()+type.slice(1)];
    if(item){
      el.className='inv-eq-slot filled';
      el.innerHTML=`<span class="ieq-icon">${item.icon}</span><span class="ieq-label">${cfg.label}</span>`;
      el.style.borderColor=(item.color||'#15803d')+'88';
    } else {
      el.className='inv-eq-slot';
      el.innerHTML=`<span style="font-size:16px;color:#d0cfc8">${cfg.fallback}</span><span class="ieq-label" style="color:#d0cfc8">${cfg.label}</span>`;
      el.style.borderColor='';
    }
  });
}
function updateLoadoutHint(){
  document.getElementById('loadout-hint').textContent=
    selectedStorage!==null?'â† é€‰æ‹©æ”¾ç½®ä½ç½®':'';
}

function clickEquipSlot(type){
  if(selectedStorage!==null&&stash[selectedStorage]){
    const it=stash[selectedStorage];
    const isWand=!it.type;
    const itType=isWand?'weapon':it.type;
    if(itType===type||(type==='weapon'&&isWand)){
      // Unequip current if any
      if(equipSlots[type]) addToStash(equipSlots[type]);
      if(it.type==='crystal'){return;} // crystals go to ammo slots
      equipSlots[type]=Object.assign({},it);
      stash.splice(selectedStorage,1);
      selectedStorage=null;
      updateLoadoutHint();
      renderHomebase();
    }
  } else {
    selectedEquipSlot=(selectedEquipSlot===type)?null:type;
    renderHomebase();
  }
}

function unequipSlot(type,e){
  e.stopPropagation();
  if(equipSlots[type]){addToStash(equipSlots[type]);equipSlots[type]=null;}
  renderHomebase();
}

function clickAmmoSlot(i){
  if(selectedStorage!==null&&stash[selectedStorage]){
    const it=stash[selectedStorage];
    if(it.type!=='crystal'){return;}
    if(ammoSlots[i]&&ammoSlots[i].crystal.id===it.id){
      // Stack
      ammoSlots[i].qty=Math.min(99,(ammoSlots[i].qty||0)+(it.qty||1));
      stash.splice(selectedStorage,1);
    } else if(!ammoSlots[i]){
      ammoSlots[i]={crystal:Object.assign({},it),qty:it.qty||1};
      stash.splice(selectedStorage,1);
    } else {
      // Swap
      addToStash(Object.assign({},ammoSlots[i].crystal,{qty:ammoSlots[i].qty}));
      ammoSlots[i]={crystal:Object.assign({},it),qty:it.qty||1};
      stash.splice(selectedStorage,1);
    }
    selectedStorage=null;
    updateLoadoutHint();
    renderHomebase();
  }
}

function clearAmmoSlot(i,e){
  e.stopPropagation();
  if(ammoSlots[i]){
    addToStash(Object.assign({},ammoSlots[i].crystal,{qty:ammoSlots[i].qty}));
    ammoSlots[i]=null;
  }
  renderHomebase();
}

function addToStash(it){
  // If crystal, try stacking
  if(it.type==='crystal'){
    const existing=stash.find(s=>s.id===it.id&&s.type==='crystal'&&(s.qty||1)<99);
    if(existing){existing.qty=Math.min(99,(existing.qty||1)+(it.qty||1));return;}
  }
  if(stash.length<20) stash.push(Object.assign({},it));
}

function sellItem(id,price){
  const idx=stash.findIndex(s=>s.id===id);
  if(idx<0){addLog('ä»“åº“ä¸­æ— æ­¤ç‰©å“','dmg');return;}
  stash.splice(idx,1);
  gold+=price;
  addLog(`å–å‡º +â—ˆ${price}`,'loot');
  renderHomebase();
}

function buyItem(id,price){
  if(gold<price){addLog('é‡‘å¸ä¸è¶³','dmg');return;}
  if(stash.length>=20){addLog('ä»“åº“å·²æ»¡','dmg');return;}
  const it=ALL_ITEMS.find(w=>w.id===id);
  if(!it)return;
  const item=Object.assign({},it);
  if(item.type==='crystal') item.qty=10;
  addToStash(item);
  gold-=price;
  addLog(`è´­ä¹° ${it.name}`,'info');
  renderHomebase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAID START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRaid(){
  genMap();
  initPlayer();
  spawnChests();
  spawnEnemies();
  projectiles=[];particles=[];droppedWands=[];
  pickupTarget=null;pickupProgress=0;selectedInvIdx=null;
  frames=0;gameState='playing';

  document.getElementById('homebase').style.display='none';
  document.getElementById('hud').style.display='block';
  document.getElementById('death-screen').style.display='none';
  document.getElementById('extract-screen').style.display='none';
  document.getElementById('gold-display').textContent=`â—ˆ ${gold}`;

  if(isTouchDevice()){
    document.getElementById('joystick-base').style.display='block';
    document.getElementById('touch-btns').style.display='flex';
  }

  updateInvGrid();
  updateAmmoHud();
  addLog('è¿›å…¥ FORSAKEN SANCTUM','imp');
  addLog('æœåˆ®Â·æ’¤ç¦»Â·å‹¿æ­»','info');
  // increment raids counter async
  if(currentUser&&currentSlot){
    sb.from('saves').select('raids').eq('user_id',currentUser.id).eq('slot',currentSlot).single()
      .then(({data})=>{
        const r=(data?.raids||0)+1;
        sb.from('saves').update({raids:r}).eq('user_id',currentUser.id).eq('slot',currentSlot);
      });
  }
  selectedStorage=null;selectedLoadout=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW â€” 2.5D ELEVATION SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const mmCanvas=document.getElementById('mm-canvas');
const mmCtx=mmCanvas.getContext('2d');

// Visual Y offset per elevation level (higher = drawn higher up on screen)
const ELEV_Y_OFFSET=[0,-16,-32];
const FLOOR_TOP=[
  ['#16161f','#141419','#17171e'],  // lv0 dark stone
  ['#1e2232','#1c2030','#20253a'],  // lv1 raised blue-grey
  ['#26203e','#231e3c','#2a2446'],  // lv2 high platform purple
];
const LEDGE_FACE=[
  null,
  ['#0c0c18','#0a0a14','#0e0e1c'],
  ['#120d26','#100b22','#150f2c'],
];
const WALL_TOP =['#1c1c2a','#191926','#202030'];
const WALL_FACE=['#0c0c16','#0a0a12','#0f0f1e'];

function worldToScreen(wx,wy,elv){
  const e=elv!==undefined?elv:getElev(wx,wy);
  return{x:wx-cam.x, y:wy-cam.y+ELEV_Y_OFFSET[e]};
}
function entityScreenY(wy,elv){ return wy-cam.y+ELEV_Y_OFFSET[elv||0]; }

function drawMap(){
  const sc=Math.max(0,Math.floor(cam.x/TILE));
  const ec=Math.min(COLS,Math.ceil((cam.x+W)/TILE)+2);
  const sr=Math.max(0,Math.floor(cam.y/TILE));
  const er=Math.min(ROWS,Math.ceil((cam.y+H)/TILE)+4);

  // â”€â”€ Pass 1: Draw floor tiles with smooth height-based coloring â”€â”€
  for(let r=sr;r<er;r++){
    for(let c=sc;c<ec;c++){
      if(!tileMap[r])continue;
      const t=tileMap[r][c];
      const elv=elevMap[r]?elevMap[r][c]||0:0;
      const h=heightMap[r]?heightMap[r][c]||0:0;
      const sx=c*TILE-cam.x;
      const sy=r*TILE-cam.y+ELEV_Y_OFFSET[elv];

      if(t===1){
        // Wall â€” solid dark block with top highlight
        ctx.fillStyle=WALL_TOP[(r*3+c*7)%3];
        ctx.fillRect(sx,sy,TILE,TILE);
        ctx.fillStyle='rgba(255,255,255,0.03)';
        ctx.fillRect(sx,sy,TILE,2);
      } else {
        // Floor: color interpolated from height
        // lv0: #14141c  lv1: #1e2232  lv2: #26203e
        const t01=Math.min(1,Math.max(0,(h-0.3)/0.22)); // 0â†’1 as h goes 0.3â†’0.52
        const t12=Math.min(1,Math.max(0,(h-0.52)/0.2)); // 0â†’1 as h goes 0.52â†’0.72
        let r_=0x14,g_=0x14,b_=0x1c;
        // lerp lv0 â†’ lv1
        r_=Math.round(r_+(0x1e-0x14)*t01);
        g_=Math.round(g_+(0x22-0x14)*t01);
        b_=Math.round(b_+(0x32-0x1c)*t01);
        // lerp lv1 â†’ lv2
        r_=Math.round(r_+(0x26-0x1e)*t12);
        g_=Math.round(g_+(0x20-0x22)*t12);
        b_=Math.round(b_+(0x3e-0x32)*t12);
        ctx.fillStyle=`rgb(${r_},${g_},${b_})`;
        ctx.fillRect(sx,sy,TILE,TILE);
        // Subtle checker detail
        if((r+c)%9===0){ctx.fillStyle='rgba(255,255,255,0.01)';ctx.fillRect(sx+14,sy+14,5,5);}
      }
    }
  }

  // â”€â”€ Pass 2: Smooth ledge faces using height gradients â”€â”€
  for(let r=sr;r<er;r++){
    for(let c=sc;c<ec;c++){
      if(!tileMap[r])continue;
      const t=tileMap[r][c];
      const elv=elevMap[r]?elevMap[r][c]||0:0;
      const h=heightMap[r]?heightMap[r][c]||0:0;
      if(elv===0&&t!==1)continue;

      const sx=c*TILE-cam.x;
      const sy=r*TILE-cam.y+ELEV_Y_OFFSET[elv];
      const ci=(r*3+c*7)%3;

      // South face
      const rB=r+1;
      const elvB=rB<ROWS&&elevMap[rB]?elevMap[rB][c]||0:0;
      const tB=rB<ROWS&&tileMap[rB]?tileMap[rB][c]:0;
      const hB=rB<ROWS&&heightMap[rB]?heightMap[rB][c]||0:0;

      if(t===1?tB===0:elv>elvB){
        // Face height proportional to height difference for smooth look
        const faceH=t===1?18:Math.round(16*elv+(h-hB)*8);
        const fy=sy+TILE;
        const topColor=t===1?WALL_FACE[ci%3]:LEDGE_FACE[elv][ci%3];
        const grad=ctx.createLinearGradient(sx,fy,sx,fy+faceH);
        grad.addColorStop(0,topColor);
        grad.addColorStop(1,'rgba(0,0,0,0.95)');
        ctx.fillStyle=grad;
        ctx.fillRect(sx,fy,TILE,faceH);
        ctx.fillStyle='rgba(0,0,0,0.45)';
        ctx.fillRect(sx,fy+faceH-1,TILE,2);
      }

      // West face
      const cL=c-1;
      const elvL=cL>=0&&elevMap[r]?elevMap[r][cL]||0:0;
      const tL=cL>=0&&tileMap[r]?tileMap[r][cL]:0;
      const hL=cL>=0&&heightMap[r]?heightMap[r][cL]||0:0;
      if(t===1?tL===0:elv>elvL){
        const faceH=t===1?18:Math.round(16*elv+(h-hL)*8);
        const grad=ctx.createLinearGradient(sx-5,sy,sx,sy);
        grad.addColorStop(0,'rgba(0,0,0,0.75)');
        grad.addColorStop(1,t===1?WALL_FACE[ci%3]:LEDGE_FACE[elv][ci%3]);
        ctx.fillStyle=grad;
        ctx.fillRect(sx-5,sy+3,5,TILE+faceH-3);
      }
    }
  }

  // â”€â”€ Pass 3: Smooth contour lines at elevation transitions â”€â”€
  // Draw a soft gradient strip where height changes between tiles
  ctx.save();
  // Pass 3: contour glow at elevation boundaries (no hard lines)
  ctx.globalAlpha=0.12;
  for(let r=sr;r<er-1;r++){
    for(let c=sc;c<ec-1;c++){
      if(!tileMap[r]||!tileMap[r+1])continue;
      const e0=elevMap[r]?elevMap[r][c]||0:0;
      const e1=elevMap[r+1]?elevMap[r+1][c]||0:0;
      if(tileMap[r][c]||tileMap[r+1][c])continue;
      if(e0===e1)continue;
      // Only draw glow on the HIGH side
      if(e0<e1)continue;
      const hi=e0;
      const sx=c*TILE-cam.x;
      const sy=(r+1)*TILE-cam.y+ELEV_Y_OFFSET[e0];
      const edgeColor=hi===2?'#9d8fff':'#6a8fff';
      const grad=ctx.createLinearGradient(sx,sy-2,sx,sy+10);
      grad.addColorStop(0,edgeColor);
      grad.addColorStop(1,'transparent');
      ctx.fillStyle=grad;
      ctx.fillRect(sx,sy-2,TILE,12);
    }
  }
  ctx.restore();
}

function drawScatter(){
  for(const p of scatterProps){
    const sx=p.wx-cam.x;
    const sy=entityScreenY(p.wy,p.elv);
    if(sx<-30||sx>W+30||sy<-30||sy>H+30)continue;
    ctx.save();
    if(p.glow){
      p.phase+=0.04;
      const pulse=0.6+0.4*Math.sin(p.phase);
      ctx.shadowColor=p.color.replace('88','');
      ctx.shadowBlur=p.light?12*pulse:6*pulse;
      ctx.globalAlpha=p.light?0.6+0.4*pulse:0.7;
    } else {
      ctx.globalAlpha=0.55+Math.random()*0.05;
    }
    ctx.font=`${Math.round(p.r*p.scale*2)}px sans-serif`;
    ctx.textAlign='center';
    ctx.fillStyle=p.color;
    ctx.fillText(p.icon,sx,sy+p.r);
    // Torch: draw small flame above
    if(p.light){
      const fp=0.5+0.5*Math.sin(p.phase*2.3);
      ctx.globalAlpha=0.4+0.4*fp;
      ctx.shadowColor='#f97316';ctx.shadowBlur=16;
      ctx.fillStyle='#fb923c';
      ctx.font='10px sans-serif';
      ctx.fillText('ğŸ”¥',sx,sy-4);
    }
    ctx.restore();
  }
}

function drawExtractPoint(){
  const elv=getElev(extractPoint.wx,extractPoint.wy);
  const sx=extractPoint.wx-cam.x;
  const sy=entityScreenY(extractPoint.wy,elv);
  if(sx<-70||sx>W+70||sy<-70||sy>H+70)return;
  const p=.5+.5*Math.sin(frames*.08);
  ctx.save();
  ctx.globalAlpha=.12+p*.12;ctx.fillStyle='#4ade80';
  ctx.beginPath();ctx.arc(sx,sy,48+p*10,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;ctx.strokeStyle='#4ade80';ctx.lineWidth=2;
  ctx.shadowColor='#4ade80';ctx.shadowBlur=14;
  ctx.beginPath();ctx.arc(sx,sy,36,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='#4ade80';ctx.font='18px sans-serif';ctx.textAlign='center';
  ctx.fillText('â–²',sx,sy+6);
  ctx.font='8px "Share Tech Mono"';ctx.fillText('EXTRACT',sx,sy+20);
  ctx.restore();
}

function drawChests(){
  for(const ch of chests){
    if(ch.opened)continue;
    const elv=getElev(ch.wx,ch.wy);
    const sx=ch.wx-cam.x;
    const sy=entityScreenY(ch.wy,elv);
    if(sx<-30||sx>W+30||sy<-30||sy>H+30)continue;
    ch.gp+=.035;
    const g=.5+.5*Math.sin(ch.gp);
    const isTarget=pickupTarget===ch;
    ctx.save();
    ctx.shadowColor=ch.wand.color;ctx.shadowBlur=8+g*12;
    ctx.fillStyle='#13131f';ctx.fillRect(sx-11,sy-11,22,22);
    ctx.strokeStyle=isTarget?'#fbbf24':ch.wand.color;
    ctx.lineWidth=isTarget?2:1.5;ctx.strokeRect(sx-11,sy-11,22,22);
    ctx.font='14px sans-serif';ctx.textAlign='center';
    ctx.fillStyle=ch.wand.color;ctx.fillText(ch.wand.icon,sx,sy+5);
    ctx.restore();
    if(dist(player.wx,player.wy,ch.wx,ch.wy)<PICKUP_RANGE){
      ctx.fillStyle='#fbbf24';ctx.font='7px "Share Tech Mono"';ctx.textAlign='center';
      ctx.fillText(isTarget?'æ‹¾å–ä¸­...':'[ç‚¹å‡»æ‹¾å–]',sx,sy-16);
    }
  }
}

function drawDroppedWands(){
  for(const dw of droppedWands){
    const elv=getElev(dw.wx,dw.wy);
    const sx=dw.wx-cam.x;
    const sy=entityScreenY(dw.wy,elv);
    if(sx<-30||sx>W+30||sy<-30||sy>H+30)continue;
    const isTarget=pickupTarget===dw;
    ctx.save();ctx.shadowColor=dw.wand.color;ctx.shadowBlur=14;
    ctx.font='16px sans-serif';ctx.textAlign='center';
    ctx.fillStyle=dw.wand.color;ctx.fillText(dw.wand.icon,sx,sy+5);
    if(isTarget){ctx.strokeStyle='#fbbf24';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(sx,sy,16,0,Math.PI*2);ctx.stroke();}
    ctx.restore();
    if(dist(player.wx,player.wy,dw.wx,dw.wy)<PICKUP_RANGE){
      ctx.fillStyle='#fbbf24';ctx.font='7px "Share Tech Mono"';ctx.textAlign='center';
      ctx.fillText(isTarget?'æ‹¾å–ä¸­...':'[ç‚¹å‡»æ‹¾å–]',sx,sy-18);
    }
  }
}

// Painter's algorithm: sort all entities by (wy + elev*1000) back-to-front
function drawEntitiesSorted(){
  const pElev=getElev(player.wx,player.wy);
  const ents=[];
  for(const e of enemies){
    const sx=e.wx-cam.x, sy=entityScreenY(e.wy,e.elev);
    if(sx<-60||sx>W+60||sy<-80||sy>H+60)continue;
    ents.push({type:'e',e,sortY:e.wy+e.elev*1000});
  }
  if(gameState!=='dead')
    ents.push({type:'p',sortY:player.wy+pElev*1000});
  ents.sort((a,b)=>a.sortY-b.sortY);
  for(const ent of ents){
    if(ent.type==='e')_drawEnemy(ent.e,pElev);
    else _drawPlayer(pElev);
  }
}

function _drawEnemy(e,pElev){
  const sx=e.wx-cam.x;
  const sy=entityScreenY(e.wy,e.elev);
  const canHit=canAttack(e.elev,pElev);

  // Ground shadow (at world floor level, no elev offset)
  ctx.save();
  ctx.globalAlpha=0.25;
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.ellipse(sx,e.wy-cam.y+2,e.r*.85,e.r*.28,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  ctx.save();
  ctx.shadowColor=e.color;ctx.shadowBlur=canHit?14:3;
  const bg=ctx.createRadialGradient(sx-3,sy-4,1,sx,sy,e.r);
  bg.addColorStop(0,e.color+'dd');bg.addColorStop(1,e.color+'22');
  ctx.fillStyle=bg;
  ctx.beginPath();ctx.arc(sx,sy,e.r,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle=e.color;
  ctx.lineWidth=canHit?1.8:0.5;
  ctx.globalAlpha=canHit?1:0.35;
  ctx.stroke();
  ctx.restore();

  // Elevation dot above head
  if(e.elev>0){
    ctx.save();
    ctx.fillStyle=e.elev===2?'#67e8f9':'#fbbf24';
    ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(sx,sy-e.r-7,3,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }

  // HP bar
  if(e.hp<e.maxHp){
    const bw=e.r*2+6,bh=3,bx=sx-bw/2,by=sy-e.r-14;
    ctx.fillStyle='#080810';ctx.fillRect(bx,by,bw,bh);
    ctx.fillStyle=e.color;ctx.fillRect(bx,by,bw*(e.hp/e.maxHp),bh);
  }
}

function _drawPlayer(pElev){
  const sx=player.wx-cam.x;
  const bounce=player.visualBounce||0;
  const sy=entityScreenY(player.wy,pElev)+bounce;
  const w=getEquipped();
  const color=w?w.color:'#e2e8f0';

  // Ground shadow
  ctx.save();
  ctx.globalAlpha=0.3;
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.ellipse(sx,player.wy-cam.y+2,player.r*.85,player.r*.28,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  ctx.save();
  ctx.shadowColor=color;ctx.shadowBlur=20;
  ctx.strokeStyle=color;ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(sx,sy,player.r+5,0,Math.PI*2);ctx.stroke();
  const g=ctx.createRadialGradient(sx-3,sy-4,1,sx,sy,player.r);
  g.addColorStop(0,'#f1f5f9');g.addColorStop(1,'#94a3b8');
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(sx,sy,player.r,0,Math.PI*2);ctx.fill();
  ctx.restore();

  const range=w?w.range:40;
  ctx.save();ctx.globalAlpha=.05;ctx.strokeStyle=color;ctx.lineWidth=1;
  ctx.setLineDash([4,6]);ctx.beginPath();ctx.arc(sx,sy,range,0,Math.PI*2);ctx.stroke();
  ctx.restore();

  document.getElementById('elev-badge').textContent=ELEV_NAMES[pElev];
  document.getElementById('elev-badge').style.color=ELEV_COLORS[pElev];
}

function drawProjectiles(){
  for(const p of projectiles){
    const sx=p.wx-cam.x;
    const sy=entityScreenY(p.wy,p.fromElev||0);
    ctx.save();ctx.shadowColor=p.color;ctx.shadowBlur=12;
    ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(sx,sy,p.r,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

function drawParticles(){
  for(const p of particles){
    const sx=p.wx-cam.x,sy=p.wy-cam.y;
    ctx.save();ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(sx,sy,p.r*(p.life/p.maxLife),0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

function drawMinimap(){
  const mm=mmCtx,mw=90,mh=90;
  const sxr=MAP_W/mw,syr=MAP_H/mh;
  mm.fillStyle='#070710';mm.fillRect(0,0,mw,mh);
  const ELEV_MM=['#101018','#161628','#1e1838'];
  for(let r=0;r<ROWS;r+=2)for(let c=0;c<COLS;c+=2){
    if(!tileMap[r])continue;
    const t=tileMap[r][c];
    const elv=elevMap[r]?elevMap[r][c]||0:0;
    mm.fillStyle=t===1?'#242434':ELEV_MM[elv];
    mm.fillRect(c*TILE/sxr,r*TILE/syr,2,2);
  }
  mm.fillStyle='#e53e3e';enemies.forEach(e=>mm.fillRect(e.wx/sxr-1,e.wy/syr-1,2,2));
  mm.fillStyle='#4ade80';mm.fillRect(extractPoint.wx/sxr-2,extractPoint.wy/syr-2,5,5);
  mm.fillStyle='#fbbf24';chests.forEach(ch=>{if(!ch.opened)mm.fillRect(ch.wx/sxr-1,ch.wy/syr-1,2,2);});
  mm.fillStyle='#fff';mm.beginPath();mm.arc(player.wx/sxr,player.wy/syr,3,0,Math.PI*2);mm.fill();
  mm.strokeStyle='#ffffff18';mm.lineWidth=.5;mm.strokeRect(cam.x/sxr,cam.y/syr,W/sxr,H/syr);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const logEl=document.getElementById('log');
function addLog(msg,cls=''){
  const d=document.createElement('div');
  d.className='log-line'+(cls?' '+cls:'');d.textContent=msg;
  logEl.prepend(d);while(logEl.children.length>7)logEl.removeChild(logEl.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key.toLowerCase()==='f')tryStartPickup();
  if(e.key.toLowerCase()==='e')cycleWeapon();
  if(e.key===' '){e.preventDefault();}
});
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// Click on canvas to start pickup
canvas.addEventListener('click',e=>{
  if(gameState!=='playing')return;
  tryStartPickup();
});
canvas.addEventListener('touchstart',e=>{
  if(gameState!=='playing')return;
  e.preventDefault();
  tryStartPickup();
},{passive:false});

function cycleWeapon(){
  if(player.inventory.length===0)return;
  player.equippedIdx=((player.equippedIdx||0)+1)%player.inventory.length;
  addLog(`è£…å¤‡: ${player.inventory[player.equippedIdx].wand.name}`,'info');
  updateInvGrid();
}

// Camera
function updateCamera(){
  cam.x=player.wx-W/2;cam.y=player.wy-H/2;
  cam.x=Math.max(0,Math.min(MAP_W-W,cam.x));
  cam.y=Math.max(0,Math.min(MAP_H-H,cam.y));
}

// Util
function dist(ax,ay,bx,by){return Math.sqrt((ax-bx)**2+(ay-by)**2);}
function normalize(dx,dy){const d=Math.sqrt(dx*dx+dy*dy)||1;return[dx/d,dy/d];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOUCH JOYSTICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initJoystick(){
  const base=document.getElementById('joystick-base');
  const knob=document.getElementById('joystick-knob');
  function center(){
    const r=base.getBoundingClientRect();
    const ar=document.getElementById('app').getBoundingClientRect();
    const sc=ar.width/900;
    return{x:(r.left+r.width/2-ar.left)/sc,y:(r.top+r.height/2-ar.top)/sc};
  }
  base.addEventListener('touchstart',e=>{e.preventDefault();joystickActive=true;joystickOrigin=center();},{passive:false});
  base.addEventListener('touchmove',e=>{
    e.preventDefault();if(!joystickActive)return;
    const t=e.touches[0];
    const ar=document.getElementById('app').getBoundingClientRect();
    const sc=ar.width/900;
    let dx=(t.clientX-ar.left)/sc-joystickOrigin.x;
    let dy=(t.clientY-ar.top)/sc-joystickOrigin.y;
    const d=Math.sqrt(dx*dx+dy*dy);
    if(d>JOYSTICK_MAX){dx=dx/d*JOYSTICK_MAX;dy=dy/d*JOYSTICK_MAX;}
    joystickDelta={x:dx,y:dy};
    knob.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
  },{passive:false});
  const end=()=>{joystickActive=false;joystickDelta={x:0,y:0};knob.style.transform='translate(-50%,-50%)';};
  base.addEventListener('touchend',end,{passive:false});
  base.addEventListener('touchcancel',end,{passive:false});
}

function getTouchMove(){
  if(!joystickActive)return[0,0];
  return[joystickDelta.x/JOYSTICK_MAX,joystickDelta.y/JOYSTICK_MAX];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scaleApp(){
  const app=document.getElementById('app');
  const sc=Math.min(window.innerWidth/900,window.innerHeight/600);
  app.style.transform=`scale(${sc})`;
  app.style.left=((window.innerWidth-900*sc)/2)+'px';
  app.style.top=((window.innerHeight-600*sc)/2)+'px';
}
scaleApp();window.addEventListener('resize',scaleApp);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  const dt=Math.min((ts-lastTime)/1000,.05);lastTime=ts;frames++;

  if(gameState==='playing'){
    let dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy-=1;
    if(keys['s']||keys['arrowdown'])dy+=1;
    if(keys['a']||keys['arrowleft'])dx-=1;
    if(keys['d']||keys['arrowright'])dx+=1;
    const[tdx,tdy]=getTouchMove();dx+=tdx;dy+=tdy;
    if(dx||dy){
      const[nx,ny]=normalize(dx,dy);
      const nx2=player.wx+nx*player.spd,ny2=player.wy+ny*player.spd;
      if(!isSolid(nx2,player.wy))player.wx=nx2;
      if(!isSolid(player.wx,ny2))player.wy=ny2;
    }

    // Elevation jump animation
    const curElev=getElev(player.wx,player.wy);
    if(curElev!==player.prevElev){
      player.elevAnimT=0;
      player.elevAnimDir=curElev>player.prevElev?1:-1;
      player.prevElev=curElev;
    }
    if(player.elevAnimT<1){
      player.elevAnimT=Math.min(1,player.elevAnimT+dt*5);
      // Bounce curve: goes up then settles
      const t=player.elevAnimT;
      const bounce=Math.sin(t*Math.PI)*0.5*(1-t);
      player.visualBounce=bounce*14*player.elevAnimDir;
    } else {
      player.visualBounce=0;
    }

    playerShoot(dt);
    updateEnemies(dt);
    updateProjectiles(dt);
    updatePickup(dt);

    for(const p of particles){p.wx+=p.vx;p.wy+=p.vy;p.vy+=.04;p.life-=dt*.9;}
    particles=particles.filter(p=>p.life>0);

    updateCamera();
    checkExtract();

    // Respawn
    if(enemies.length<CONFIG.ENEMY_MAX){
      for(let i=0;i<CONFIG.ENEMY_RESPAWN;i++){
        let wx,wy,tries=0;
        do{wx=100+Math.random()*(MAP_W-200);wy=100+Math.random()*(MAP_H-200);tries++;}
        while((isSolid(wx,wy)||dist(wx,wy,player.wx,player.wy)<280)&&tries<40);
        const t=ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
        const drops2=rollEnemyDrops();
        enemies.push({wx,wy,hp:t.hp,maxHp:t.hp,spd:t.spd,dmg:t.dmg,color:t.color,r:t.r,xp:t.xp,name:t.name,
          elev:getElev(wx,wy),attackCd:0,attackRate:1.1,aggroRange:200,wanderAngle:Math.random()*Math.PI*2,
          drops:drops2,slowTimer:0,dotTimer:0,ranged:t.ranged||false,range:t.range||60,phase:0});
      }
    }
  }else if(gameState==='dead'){
    for(const p of particles){p.wx+=p.vx;p.wy+=p.vy;p.vy+=.05;p.life-=dt*.5;}
    particles=particles.filter(p=>p.life>0);
    updateCamera();
  }

  if(gameState==='playing'||gameState==='dead'){
    ctx.clearRect(0,0,W,H);
    drawMap();drawScatter();drawExtractPoint();drawChests();drawDroppedWands();
    drawParticles();drawEntitiesSorted();drawProjectiles();

    // Vignette
    const vig=ctx.createRadialGradient(W/2,H/2,H*.28,W/2,H/2,H*.72);
    vig.addColorStop(0,'transparent');vig.addColorStop(1,'rgba(0,0,0,.6)');
    ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);

    // Low HP
    if(gameState==='playing'&&player.hp<player.maxHp*.3){
      ctx.save();ctx.globalAlpha=.1+.08*Math.sin(frames*.3);ctx.fillStyle='#e53e3e';ctx.fillRect(0,0,W,H);ctx.restore();
    }
    drawMinimap();
  }

  requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
refreshMarket();
initJoystick();
// Don't show homebase yet â€” wait for auth check
// goHomebase() is called after login/load save
requestAnimationFrame(ts=>{lastTime=ts;requestAnimationFrame(loop);});
initAuth(); // Check session â†’ show login or save select
</script>
</body>
</html>
